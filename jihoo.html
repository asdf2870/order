<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盤點叫貨系統 - 多商家</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f8fafc; }
</style>
</head>

<body>
<div id="root" class="p-4 max-w-xl mx-auto"></div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
  authDomain: "all-sun-e7472.firebaseapp.com",
  databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "all-sun-e7472"
});
const db = firebase.database();

/* 狀態 */
let merchants = [];
let currentMerchant = '';
let items = [];
let stockCounts = {};
let dayType = 'weekday';
let managementMode = false;

const root = document.getElementById('root');

/* 商家 */
function loadMerchants() {
  db.ref('inventory_tool/merchants').once('value').then(snap => {
    const v = snap.val();
    if (v) {
      merchants = Object.keys(v);
      if (!currentMerchant) currentMerchant = merchants[0];
    } else {
      merchants = ['商家A'];
      currentMerchant = '商家A';
      db.ref('inventory_tool/merchants').set({ 商家A: true });
    }
    loadData();
  });
}

function loadData() {
  db.ref('inventory_tool/' + currentMerchant).once('value').then(snap => {
    const v = snap.val() || {};
    items = v.items || [];
    stockCounts = v.stockCounts || {};
    render();
  });
}

function syncCloud() {
  db.ref('inventory_tool/' + currentMerchant).set({ items, stockCounts });
}

/* 計算補貨量（原本就有的邏輯） */
function calculateNeed(item, stock) {
  const current = parseFloat(stock) || 0;
  const min = dayType === 'weekday'
    ? (item.weekdayMin || 0)
    : (item.weekendMin || 0);
  const need = min - current;
  return need > 0 ? need : 0;
}

/* UI */
function render() {
  root.innerHTML = `
    <div class="flex gap-2 mb-3">
      <select onchange="changeMerchant(this.value)" class="flex-1 border p-2 rounded">
        ${merchants.map(m=>`<option ${m===currentMerchant?'selected':''}>${m}</option>`).join('')}
      </select>
      <button onclick="manageMerchant()" class="px-3 bg-slate-600 text-white rounded">
        管理商家
      </button>
    </div>

    <div class="flex justify-between mb-3">
      <h1 class="font-bold text-lg">盤點叫貨系統</h1>
      <button onclick="toggleManage()" class="px-3 py-1 bg-blue-600 text-white rounded">
        ${managementMode?'完成設定':'管理品項'}
      </button>
    </div>

    <div class="flex gap-2 mb-4">
      <button onclick="setDay('weekday')" class="flex-1 py-1 ${dayType==='weekday'?'bg-blue-600 text-white':'bg-slate-200'}">平日</button>
      <button onclick="setDay('weekend')" class="flex-1 py-1 ${dayType==='weekend'?'bg-orange-500 text-white':'bg-slate-200'}">假日</button>
    </div>

    ${items.map(item => `
      <div class="bg-white p-2 mb-2 rounded shadow">
        ${managementMode ? `
          <input value="${item.name}" onchange="editItem(${item.id},'name',this.value)" class="w-full border-b mb-1">
          <div class="flex gap-2">
            <input type="number" value="${item.weekdayMin||0}" onchange="editItem(${item.id},'weekdayMin',this.value)" class="w-1/2 border p-1" placeholder="平日最低">
            <input type="number" value="${item.weekendMin||0}" onchange="editItem(${item.id},'weekendMin',this.value)" class="w-1/2 border p-1" placeholder="假日最低">
          </div>
          <input value="${item.unit||''}" onchange="editItem(${item.id},'unit',this.value)" class="w-full border p-1 mt-1" placeholder="單位">
          <input value="${(item.relatedItems||[]).join(',')}" onchange="editItem(${item.id},'relatedItems',this.value)" class="w-full border p-1 mt-1" placeholder="關聯食材">
        ` : `
          <div class="flex justify-between items-center">
            <span>${item.name}</span>
            <div>
              <button onclick="adjustStock(${item.id},-0.5)">−</button>
              ${stockCounts[item.id]||0} ${item.unit||''}
              <button onclick="adjustStock(${item.id},0.5)">＋</button>
            </div>
          </div>
        `}
      </div>
    `).join('')}

    ${managementMode ? `
      <button onclick="addItem()" class="w-full border-dashed border-2 p-2 mt-2">新增品項</button>
    `:''}

    <!-- ✅ 補貨清單（補回來的部分） -->
    <div class="mt-4 bg-white p-3 rounded shadow">
      <h2 class="font-bold mb-2">補貨清單</h2>
      ${renderOrderList()}
    </div>
  `;
}

/* 補貨清單 UI */
function renderOrderList() {
  const list = [];
  items.forEach(item => {
    const need = calculateNeed(item, stockCounts[item.id]);
    if (need > 0) {
      if (item.relatedItems && item.relatedItems.length > 0) {
        list.push(...item.relatedItems);
      } else {
        list.push(`${item.name} +${need} ${item.unit||''}`);
      }
    }
  });

  if (list.length === 0) {
    return `<p class="text-sm text-slate-400">目前無需補貨</p>`;
  }

  return `
    <p class="text-sm mb-2">${list.join('， ')}</p>
    <button onclick="copyOrder(${JSON.stringify(list)})"
      class="w-full py-2 bg-blue-600 text-white rounded">
      一鍵複製補貨清單
    </button>
  `;
}

/* 行為 */
function changeMerchant(m){ currentMerchant=m; loadData(); }
function toggleManage(){ managementMode=!managementMode; render(); }
function setDay(d){ dayType=d; render(); }

function manageMerchant(){
  const cmd=prompt('新增:商家C 或 刪除:商家B');
  if(!cmd) return;
  const [a,n]=cmd.split(':');
  if(a==='新增') db.ref('inventory_tool/merchants/'+n).set(true);
  if(a==='刪除') db.ref('inventory_tool/merchants/'+n).remove();
  loadMerchants();
}

function addItem(){
  items.push({id:Date.now(),name:'',weekdayMin:0,weekendMin:0,unit:'',relatedItems:[]});
  syncCloud(); render();
}

function editItem(id,k,v){
  const i=items.find(x=>x.id===id);
  if(k==='relatedItems') i[k]=v.split(',').map(s=>s.trim());
  else i[k]=isNaN(v)?v:+v;
  syncCloud();
}

function adjustStock(id,d){
  stockCounts[id]=(stockCounts[id]||0)+d;
  if(stockCounts[id]<0) stockCounts[id]=0;
  syncCloud(); render();
}

function copyOrder(list){
  navigator.clipboard.writeText(list.join('\n'));
  alert('已複製到剪貼簿');
}

/* 啟動 */
loadMerchants();
</script>
</body>
</html>
