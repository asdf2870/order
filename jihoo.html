<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>多商家盤點補貨系統</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f4f7f6; }
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {-webkit-appearance:none;margin:0;}
.custom-scrollbar::-webkit-scrollbar{width:4px;}
.custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px;}
</style>
</head>
<body class="p-4 md:p-8">
<div id="root" class="max-w-4xl mx-auto"></div>

<script type="text/babel">

const { useState, useEffect, useMemo } = React;

// --- Firebase 配置 ---
const firebaseConfig = {
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  projectId: "ngdd-8dd14",
  storageBucket: "ngdd-8dd14.firebasestorage.app",
  messagingSenderId: "780195335307",
  appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e",
  databaseURL: "https://ngdd-8dd14-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const App = () => {
  const [currentMerchant, setCurrentMerchant] = useState('merchant_NGD');
  const [merchants, setMerchants] = useState([]);
  const [items, setItems] = useState([]);
  const [stockCounts, setStockCounts] = useState({});
  const [dayType, setDayType] = useState('weekday');
  const [loading, setLoading] = useState(true);
  const [manageMode, setManageMode] = useState(false);

  useEffect(()=>{
    // 監聽商家列表
    db.ref('inventory_tool').on('value', snapshot=>{
      const val = snapshot.val() || {};
      setMerchants(Object.keys(val));
      if(!items.length && val[currentMerchant]?.items) setItems(val[currentMerchant].items);
      if(val[currentMerchant]?.stockCounts) setStockCounts(val[currentMerchant].stockCounts);
      setLoading(false);
    });
  },[]);

  const syncToCloud = ()=>{
    db.ref(`inventory_tool/${currentMerchant}`).set({
      items, stockCounts
    });
  };

  const addItem = ()=>{
    const newItem = {id:Date.now(), name:'', weekday:0, weekend:0, unit:'', related:[], round:false};
    const newItems = [...items,newItem];
    setItems(newItems);
    syncToCloud();
  };

  const updateItem = (id, field, value)=>{
    const newItems = items.map(i=>i.id===id ? {...i,[field]:value}:i);
    setItems(newItems);
    syncToCloud();
  };

  const calculateNeed = (item)=>{
    const current = parseFloat(stockCounts[item.id]||0);
    const min = dayType==='weekday'?item.weekday:item.weekend;
    let need = min - current;
    return need>0 ? (item.round?Math.round(need):parseFloat(need.toFixed(2))) : 0;
  };

  const orderList = useMemo(()=>{
    return items.map(i=>{
      const need = calculateNeed(i);
      return need>0 ? {related:i.related} : null;
    }).filter(Boolean);
  },[items, stockCounts, dayType]);

  const copyOrder = ()=>{
    const label = dayType==='weekday' ? '平日' : '假日';
    const summary = orderList.map(i=>i.related.join(', ')).join('\n');
    if(!summary){ alert("無需補貨"); return;}
    const ta = document.createElement("textarea");
    ta.value = `【${label}補貨清單】\n${summary}`;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert("已複製補貨清單");
  };

  if(loading) return <div className="text-center py-20 animate-pulse text-slate-400">盤點資料讀取中...</div>;

  return (
    <div className="bg-white shadow-lg rounded p-4">
      <header className="mb-3 flex justify-between items-center">
        <div>
          <select value={currentMerchant} onChange={e=>setCurrentMerchant(e.target.value)} className="border rounded px-2 py-1">
            {merchants.map(m=><option key={m} value={m}>{m}</option>)}
          </select>
        </div>
        <button onClick={()=>setManageMode(!manageMode)} className="px-3 py-1 bg-blue-500 text-white rounded">{manageMode?'完成設定':'管理品項'}</button>
        <button onClick={copyOrder} className="px-3 py-1 bg-green-500 text-white rounded">複製補貨清單</button>
      </header>

      <div className="flex gap-2 mb-3">
        <button onClick={()=>setDayType('weekday')} className={`flex-1 py-1 rounded ${dayType==='weekday'?'bg-blue-600 text-white':'bg-slate-200'}`}>平日</button>
        <button onClick={()=>setDayType('weekend')} className={`flex-1 py-1 rounded ${dayType==='weekend'?'bg-orange-600 text-white':'bg-slate-200'}`}>假日</button>
      </div>

      <div className="space-y-2">
        {items.map(item=>{
          const need = calculateNeed(item);
          return (
            <div key={item.id} className="flex items-center justify-between p-2 border rounded">
              <span>{item.name} ({dayType==='weekday'?item.weekday:item.weekend}{item.unit})</span>
              {!manageMode && 
                <input type="number" step="0.5" value={stockCounts[item.id]||''} 
                  onChange={e=>{
                    stockCounts[item.id]=e.target.value;
                    setStockCounts({...stockCounts});
                    syncToCloud();
                  }}
                  className="w-20 border p-1 text-right"
                />
              }
              {manageMode && 
                <button onClick={()=>updateItem(item.id,'name',prompt('名稱',item.name)||item.name)} className="px-2 py-0.5 bg-yellow-300 text-xs rounded">編輯</button>
              }
            </div>
          );
        })}
      </div>

      <div className="mt-4">
        <button onClick={addItem} className="w-full py-2 border-2 border-dashed text-slate-500 rounded">+ 新增品項</button>
      </div>

      <div className="mt-4 p-2 bg-slate-100 rounded min-h-[80px]">
        <h3 className="font-bold mb-2">補貨清單</h3>
        <pre className="text-sm whitespace-pre-wrap">
          {orderList.map((i,idx)=>i.related.join(', ')).join('\n') || '目前無缺貨品項'}
        </pre>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
