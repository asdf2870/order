<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ç›¤é»è£œè²¨å·¥å…·</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body { font-family: system-ui, -apple-system, BlinkMacSystemFont; background:#f8fafc }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">

/* ğŸ”¥ Firebase è¨­å®šï¼ˆç”¨ä½ ç¾åœ¨é‚£çµ„å³å¯ï¼‰ */
const firebaseConfig = {
  apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
  authDomain: "ngdd-8dd14.firebaseapp.com",
  databaseURL: "https://ngdd-8dd14-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ngdd-8dd14",
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const { useState, useEffect } = React;

function App() {
  const [loading, setLoading] = useState(true);
  const [mode, setMode] = useState("use"); // use | manage
  const [dayType, setDayType] = useState("weekday");
  const [merchant, setMerchant] = useState("default");
  const [merchants, setMerchants] = useState({});
  const [items, setItems] = useState([]);
  const [stock, setStock] = useState({});

  /* åˆå§‹åŒ– */
  useEffect(() => {
    const ref = db.ref("app");
    ref.on("value", snap => {
      let data = snap.val();
      if (!data) {
        data = {
          merchants: {
            default: { name: "é è¨­å•†å®¶", items: [] }
          }
        };
        ref.set(data);
      }
      setMerchants(data.merchants);
      setItems(data.merchants[merchant]?.items || []);
      setLoading(false);
    });
    return () => ref.off();
  }, [merchant]);

  const saveItems = newItems => {
    db.ref(`app/merchants/${merchant}/items`).set(newItems);
    setItems(newItems);
  };

  const need = item => {
    const current = Number(stock[item.id] || 0);
    const min = dayType === "weekday" ? item.weekdayMin : item.weekendMin;
    return Math.max(min - current, 0);
  };

  const orderList = [];
  items.forEach(item => {
    const n = need(item);
    if (n > 0) {
      if (item.related?.trim()) {
        item.related.split("\n").forEach(r => orderList.push(r));
      } else {
        orderList.push(`${item.name} ${n}${item.unit || ""}`);
      }
    }
  });

  if (loading) {
    return <div className="p-10 text-center text-slate-400">ç›¤é»è³‡æ–™è®€å–ä¸­â€¦</div>;
  }

  return (
    <div className="max-w-md mx-auto bg-white min-h-screen flex flex-col">

      {/* Header */}
      <div className="p-4 border-b flex justify-between items-center">
        <div className="font-bold">ç›¤é»</div>
        <button
          className="text-sm text-slate-500"
          onClick={() => setMode(mode === "use" ? "manage" : "use")}
        >
          {mode === "use" ? "ç®¡ç†" : "å®Œæˆ"}
        </button>
      </div>

      {/* Day Switch */}
      <div className="flex text-sm border-b">
        <button className={`flex-1 p-2 ${dayType==="weekday"?"font-bold":""}`} onClick={()=>setDayType("weekday")}>å¹³æ—¥</button>
        <button className={`flex-1 p-2 ${dayType==="weekend"?"font-bold":""}`} onClick={()=>setDayType("weekend")}>å‡æ—¥</button>
      </div>

      {/* List */}
      <div className="flex-1 divide-y">
        {items.map(item => (
          <div key={item.id} className="flex items-center p-3 gap-2">
            <div className="flex-1 truncate">{item.name}</div>
            <input
              type="number"
              className="w-16 text-right bg-slate-100 rounded px-2"
              placeholder="ç¾æœ‰"
              value={stock[item.id] || ""}
              onChange={e => setStock({...stock,[item.id]:e.target.value})}
            />
            <div className="w-16 text-right text-red-500">
              {need(item) > 0 ? `+${need(item)}` : ""}
            </div>
          </div>
        ))}
      </div>

      {/* Order */}
      <div className="p-3 border-t bg-slate-50">
        <div className="text-xs whitespace-pre-line mb-2">
          {orderList.join("\n") || "ç›®å‰ç„¡éœ€è£œè²¨"}
        </div>
        <button
          className="w-full bg-black text-white py-2 rounded"
          onClick={() => navigator.clipboard.writeText(orderList.join("\n"))}
        >
          ä¸€éµè¤‡è£½è£œè²¨æ¸…å–®
        </button>
      </div>

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
