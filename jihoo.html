<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盤點補貨管理</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

// ---------- Firebase 初始化 ----------
const firebaseConfig = {
  apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
  authDomain: "all-sun-e7472.firebaseapp.com",
  projectId: "all-sun-e7472",
  storageBucket: "all-sun-e7472.firebasestorage.app",
  messagingSenderId: "679291601652",
  appId: "1:679291601652:web:af747f74bdb9afe0bc94a1",
  databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------- App ----------
const App = () => {
    const [items, setItems] = useState([]);
    const [stockCounts, setStockCounts] = useState({});
    const [loading, setLoading] = useState(true);
    const [showCopy, setShowCopy] = useState(false);

    // 監聽 Firebase 資料
    useEffect(() => {
        const ref = db.ref('inventory_tool');
        ref.on('value', snapshot => {
            const val = snapshot.val();
            if (val) {
                setItems(val.items || []);
                setStockCounts(val.stockCounts || {});
            } else {
                // 初始化資料
                const initialData = {
                    items: [],
                    stockCounts: {}
                };
                ref.set(initialData);
            }
            setLoading(false);
        });
        return () => ref.off();
    }, []);

    // 同步 Firebase
    const sync = (newItems, newCounts) => {
        db.ref('inventory_tool').update({ items: newItems, stockCounts: newCounts });
    };

    const addItem = () => {
        const newItem = { id: Date.now(), name: '', weekdayMin: 0, weekendMin: 0, unit: '', related: [] };
        const newItems = [...items, newItem];
        setItems(newItems);
        sync(newItems, stockCounts);
    };

    const updateItem = (id, field, value) => {
        const newItems = items.map(it => it.id === id ? { ...it, [field]: value } : it);
        setItems(newItems);
        sync(newItems, stockCounts);
    };

    const handleCountChange = (id, val) => {
        const newCounts = {...stockCounts, [id]: val};
        setStockCounts(newCounts);
        sync(items, newCounts);
    };

    // 計算需要補多少
    const calculateNeed = (item, current) => {
        const cur = parseFloat(current||0);
        let need = Math.max(0, (item.weekdayMin||0) - cur);
        return parseFloat(need.toFixed(2));
    };

    // 補貨清單
    const orderList = useMemo(() => {
        return items
            .filter(item => calculateNeed(item, stockCounts[item.id]) > 0)
            .map(item => ({ ...item, need: calculateNeed(item, stockCounts[item.id]) }));
    }, [items, stockCounts]);

    const copyOrder = () => {
        const text = orderList.map(i => {
            if(i.related && i.related.length) return i.related.join(", ");
            return `${i.name} ${i.need} ${i.unit}`;
        }).join("\n");
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        setShowCopy(true);
        setTimeout(() => setShowCopy(false), 2000);
    };

    if(loading) return <div className="flex h-screen items-center justify-center text-slate-400 font-bold animate-pulse">盤點資料讀取中...</div>;

    return (
        <div className="max-w-2xl mx-auto min-h-screen p-3">
            <h1 className="text-xl font-bold mb-3">盤點補貨工具</h1>
            
            {/* 盤點列表 */}
            <div className="space-y-3 mb-5">
                {items.map(item => (
                    <div key={item.id} className="flex gap-2 items-center">
                        <input 
                            type="number" step="0.5" value={stockCounts[item.id]||''} 
                            onChange={e => handleCountChange(item.id, e.target.value)}
                            placeholder="現有量" className="flex-1 border rounded px-2 py-1 text-sm"
                        />
                        <span className="text-sm">{item.unit}</span>
                    </div>
                ))}
            </div>

            {/* 新增品項 */}
            <button onClick={addItem} className="w-full py-2 bg-blue-600 text-white rounded mb-5">新增品項</button>

            {/* 補貨清單 */}
            <div className="bg-white p-3 rounded shadow">
                <h2 className="font-bold mb-2">補貨清單</h2>
                {orderList.length === 0 && <p className="text-sm text-slate-400">目前無需補貨</p>}
                {orderList.map((i, idx) => (
                    <p key={idx} className="text-sm">{i.related && i.related.length ? i.related.join(", ") : `${i.name} ${i.need} ${i.unit}`}</p>
                ))}
                <button onClick={copyOrder} className={`mt-2 w-full py-1.5 rounded ${showCopy ? 'bg-green-500':'bg-blue-600'} text-white`}>{showCopy?'已複製':'一鍵複製全部'}</button>
            </div>
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
