<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盤點叫貨系統 - 多商家</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f8fafc; }
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.custom-scrollbar::-webkit-scrollbar{width:4px;}
.custom-scrollbar::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px;}
</style>
</head>
<body>
<div id="root" class="p-4"></div>

<script type="text/javascript">
  // --- Firebase 初始化 ---
  const firebaseConfig = {
    apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
    authDomain: "all-sun-e7472.firebaseapp.com",
    projectId: "all-sun-e7472",
    storageBucket: "all-sun-e7472.firebasestorage.app",
    messagingSenderId: "679291601652",
    appId: "1:679291601652:web:af747f74bdb9afe0bc94a1",
    measurementId: "G-JP2QM56TC5",
    databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- 基本資料 ---
  let items = [];
  let stockCounts = {};
  let dayType = 'weekday'; // 平日
  let managementMode = false;

  const root = document.getElementById('root');

  // --- 渲染 ---
  function render() {
    root.innerHTML = '';
    const container = document.createElement('div');

    // 標題 & 管理模式切換
    const header = document.createElement('div');
    header.className = 'flex justify-between mb-4';
    header.innerHTML = `
      <h1 class="text-xl font-bold">盤點叫貨系統</h1>
      <button id="toggleManage" class="px-2 py-1 bg-blue-600 text-white rounded">${managementMode ? '完成設定' : '管理品項'}</button>
    `;
    container.appendChild(header);
    root.appendChild(container);

    document.getElementById('toggleManage').onclick = () => {
      managementMode = !managementMode;
      render();
    };

    // 平日/假日切換
    const dayDiv = document.createElement('div');
    dayDiv.className = 'flex gap-2 mb-4';
    dayDiv.innerHTML = `
      <button id="btnWeekday" class="flex-1 py-1 ${dayType==='weekday'?'bg-blue-600 text-white':'bg-slate-200'}">平日</button>
      <button id="btnWeekend" class="flex-1 py-1 ${dayType==='weekend'?'bg-orange-500 text-white':'bg-slate-200'}">假日</button>
    `;
    container.appendChild(dayDiv);

    document.getElementById('btnWeekday').onclick = () => { dayType='weekday'; render(); };
    document.getElementById('btnWeekend').onclick = () => { dayType='weekend'; render(); };

    // 品項列表
    const listDiv = document.createElement('div');
    listDiv.className = 'space-y-2 mb-4';

    items.forEach(item => {
      const need = calculateNeed(item, stockCounts[item.id]);
      const div = document.createElement('div');
      div.className = 'flex items-center gap-2 p-2 bg-white rounded shadow-sm';

      if (managementMode) {
        div.innerHTML = `
          <input value="${item.name}" placeholder="品項名稱" class="border-b flex-1">
          <input type="number" value="${item.unit||0}" placeholder="單位" class="w-16">
        `;
        div.querySelector('input').oninput = e => { item.name=e.target.value; syncCloud(); };
      } else {
        div.innerHTML = `
          <span class="flex-1">${item.name}</span>
          <button onclick="adjustStock('${item.id}', -0.5)">-0.5</button>
          <input type="number" step="0.5" value="${stockCounts[item.id]||0}" class="w-16 text-center">
          <button onclick="adjustStock('${item.id}', 0.5)">+0.5</button>
        `;
        div.querySelector('input').oninput = e => { stockCounts[item.id]=parseFloat(e.target.value)||0; syncCloud(); render(); };
      }
      listDiv.appendChild(div);
    });
    container.appendChild(listDiv);

    // 新增品項按鈕
    if (managementMode) {
      const addBtn = document.createElement('button');
      addBtn.className = 'w-full py-2 border-dashed border-2 border-slate-300 rounded';
      addBtn.innerText = '新增品項';
      addBtn.onclick = () => { addItem(); };
      container.appendChild(addBtn);
    }

    // 補貨清單
    const orderDiv = document.createElement('div');
    orderDiv.className = 'mt-4 p-2 bg-white rounded shadow-sm';
    orderDiv.innerHTML = '<h2 class="font-bold mb-2">補貨清單</h2>';

    const orderList = items.map(item=>{
      const need = calculateNeed(item, stockCounts[item.id]);
      if(need>0){
        const related = item.relatedItems||[];
        return related.length>0 ? related.join(', ') : `${item.name} +${need} ${item.unit||''}`;
      }
      return null;
    }).filter(Boolean);

    if(orderList.length===0){
      orderDiv.innerHTML += '<p class="text-sm text-slate-400">目前無需補貨</p>';
    } else {
      orderDiv.innerHTML += `<p class="text-sm">${orderList.join('， ')}</p>`;
      const copyBtn = document.createElement('button');
      copyBtn.innerText = '一鍵複製補貨清單';
      copyBtn.className='mt-2 w-full py-2 bg-blue-600 text-white rounded';
      copyBtn.onclick = ()=>{ copyOrder(orderList); };
      orderDiv.appendChild(copyBtn);
    }

    container.appendChild(orderDiv);
    root.appendChild(container);
  }

  function calculateNeed(item, stock){
    const current = parseFloat(stock)||0;
    const min = dayType==='weekday'?item.weekdayMin||0:item.weekendMin||0;
    let need = min-current;
    if(need<=0) return 0;
    return item.shouldRound?Math.round(need):need;
  }

  function adjustStock(id, delta){
    stockCounts[id] = (parseFloat(stockCounts[id])||0)+delta;
    if(stockCounts[id]<0) stockCounts[id]=0;
    syncCloud();
    render();
  }

  function addItem(){
    const newItem = {id:Date.now(), name:'', weekdayMin:0, weekendMin:0, unit:'', relatedItems:[], shouldRound:false};
    items.push(newItem);
    syncCloud();
    render();
  }

  function syncCloud(){
    db.ref('inventory_tool').set({items, stockCounts});
  }

  function copyOrder(orderList){
    const textArea = document.createElement('textarea');
    textArea.value = orderList.join('\n');
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    alert('已複製到剪貼簿');
  }

  // --- 初始化 ---
  db.ref('inventory_tool').once('value').then(snapshot=>{
    const val = snapshot.val();
    if(val){
      items = val.items||[];
      stockCounts = val.stockCounts||{};
    }
    render();
  }).catch(err=>{
    console.error(err);
    render();
  });

</script>
</body>
</html>
