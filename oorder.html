<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡約盤點叫貨系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f4f7f6; color: #2d3436; font-family: sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);}
        input:focus { outline: none; border-color: #0984e3; box-shadow: 0 0 0 2px rgba(9, 132, 227, 0.1);}
        .btn-mode-active { background-color: #0984e3; color:white; }
        .btn-mode-inactive { background-color:#dfe6e9;color:#636e72; }
        .tab-active { border-bottom: 3px solid #0984e3; color:#0984e3; font-weight:bold; }
        .hidden { display: none; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin:0;}
    </style>
</head>
<body class="p-4 md:p-8">
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-center mb-6 text-slate-800">盤點叫貨系統</h1>

    <!-- 分頁導覽 -->
    <div class="flex justify-center mb-8 border-b border-slate-200">
        <button id="tabInventory" class="px-8 py-3 transition tab-active">盤點叫貨</button>
        <button id="tabSettings" class="px-8 py-3 transition text-slate-500">品項設定</button>
    </div>

    <!-- 盤點區域 -->
    <div id="pageInventory">
        <div class="card p-6 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-semibold text-slate-700">今日庫存盤點</h2>
                <div class="flex p-1 bg-slate-100 rounded-lg">
                    <button id="btnWeekday" class="px-6 py-2 rounded-md font-medium btn-mode-active transition">一至五 (平日)</button>
                    <button id="btnSaturday" class="px-6 py-2 rounded-md font-medium btn-mode-inactive transition">星期六</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="inventoryContainer"></div>
        </div>

        <!-- 統計與複製 -->
        <div class="card p-6 border-t-4 border-blue-500">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">叫貨清單統計</h2>
            <div id="summaryContent" class="bg-slate-50 p-4 rounded-lg min-h-[100px] mb-4 text-slate-700 whitespace-pre-wrap leading-relaxed">尚無叫貨項目</div>
            <button id="btnCopy" class="w-full py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition active:scale-[0.98] shadow-md">
                一鍵複製叫貨清單
            </button>
        </div>
    </div>

    <!-- 設定區域 -->
    <div id="pageSettings" class="hidden">
        <div class="card p-6 mb-8">
            <h2 class="text-xl font-semibold text-slate-700 mb-4">品項與庫存設定</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-b text-slate-500 text-sm">
                            <th class="py-3 px-1">品項名稱</th>
                            <th class="py-3 px-1 w-20 text-center">平日應備</th>
                            <th class="py-3 px-1 w-20 text-center">週六應備</th>
                            <th class="py-3 px-1 w-16 text-center">進位</th>
                            <th class="py-3 px-1 w-20">單位</th>
                            <th class="py-3 px-1 w-12 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="settingList"></tbody>
                </table>
            </div>
            <button id="btnAddItem" class="mt-6 px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition shadow-sm">
                + 新增品項
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-firestore.js";

    // Firebase 配置
    const firebaseConfig = {
        apiKey: "AIzaSyCiWs5ZtstLxSSLQHufvnrWilnnGADFbEI",
        authDomain: "ngdd-8dd14.firebaseapp.com",
        projectId: "ngdd-8dd14",
        storageBucket: "ngdd-8dd14.firebasestorage.app",
        messagingSenderId: "780195335307",
        appId: "1:780195335307:web:c6e95d1e0a7ee92cf3588e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const itemsCol = collection(db, 'items');

    // 狀態管理
    let items = [];
    let currentStocks = {};
    let needs = {};
    let currentMode = 'weekday';

    // 初始化與監聽
    onSnapshot(itemsCol, snapshot => {
        items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        items.forEach(item => {
            currentStocks[item.id] = item.currentStock || 0;
        });
        renderSettings();
        renderInventory();
    });

    // 功能函數
    async function updateItemData(id, field, value) {
        const itemRef = doc(db, 'items', id);
        if (['weekday', 'saturday', 'currentStock'].includes(field)) {
            value = parseFloat(value) || 0;
        }
        await setDoc(itemRef, { [field]: value }, { merge: true });
    }

    async function addItem() {
        const id = Date.now().toString();
        const newItem = { name: '', weekday: 0, saturday: 0, unit: '', round: false, currentStock: 0 };
        await setDoc(doc(db, 'items', id), newItem);
    }

    async function deleteItem(id) {
        await deleteDoc(doc(db, 'items', id));
        delete needs[id];
        delete currentStocks[id];
    }

    // 渲染函數
    function renderSettings() {
        const container = document.getElementById('settingList');
        container.innerHTML = '';
        items.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = 'border-b last:border-0 hover:bg-slate-50 transition';
            
            // 名稱
            const tdName = createInputTd(item.name, 'text', (val) => updateItemData(item.id, 'name', val));
            // 平日
            const tdWeekday = createInputTd(item.weekday, 'number', (val) => updateItemData(item.id, 'weekday', val), '0.1');
            // 週六
            const tdSaturday = createInputTd(item.saturday, 'number', (val) => updateItemData(item.id, 'saturday', val), '0.1');
            
            // 進位 (Checkbox)
            const tdRound = document.createElement('td');
            tdRound.className = 'py-3 px-1 text-center';
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = !!item.round;
            cb.className = 'w-4 h-4';
            cb.onchange = (e) => updateItemData(item.id, 'round', e.target.checked);
            tdRound.appendChild(cb);

            // 單位
            const tdUnit = createInputTd(item.unit, 'text', (val) => updateItemData(item.id, 'unit', val), null, '單位');

            // 刪除按鈕
            const tdAction = document.createElement('td');
            tdAction.className = 'py-3 px-1 text-center';
            const delBtn = document.createElement('button');
            delBtn.innerHTML = '&times;';
            delBtn.className = 'text-red-400 hover:text-red-600 text-2xl font-bold transition';
            delBtn.onclick = () => deleteItem(item.id);
            tdAction.appendChild(delBtn);

            tr.append(tdName, tdWeekday, tdSaturday, tdRound, tdUnit, tdAction);
            container.appendChild(tr);
        });
    }

    function createInputTd(value, type, onInput, step = null, placeholder = '') {
        const td = document.createElement('td');
        td.className = 'py-3 px-1';
        const input = document.createElement('input');
        input.type = type;
        if (step) input.step = step;
        input.value = value;
        input.placeholder = placeholder;
        input.className = 'w-full border border-slate-200 rounded p-1.5 text-sm text-center';
        input.oninput = (e) => onInput(e.target.value);
        td.appendChild(input);
        return td;
    }

    function renderInventory() {
        const container = document.getElementById('inventoryContainer');
        container.innerHTML = '';
        
        items.forEach(item => {
            if (!item.name) return;
            
            let target = currentMode === 'weekday' ? (item.weekday || 0) : (item.saturday || 0);
            if (item.round) target = Math.round(target);
            
            const currentVal = currentStocks[item.id] || 0;
            const needVal = Math.max(0, target - currentVal);
            const displayNeed = Number.isInteger(needVal) ? needVal : needVal.toFixed(1);

            if (needVal > 0) {
                needs[item.id] = `${item.name}: ${displayNeed} ${item.unit || ''}`;
            } else {
                delete needs[item.id];
            }

            const div = document.createElement('div');
            div.className = 'flex flex-col p-4 bg-slate-50 border border-slate-200 rounded-lg shadow-sm';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <span class="font-bold text-lg text-slate-700">${item.name}</span>
                    <span class="text-xs bg-white px-2 py-1 rounded-full border border-slate-200 text-slate-500 font-medium">
                        應備: ${target} ${item.unit || ''}
                    </span>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="flex flex-1 items-center bg-white border border-slate-300 rounded-md overflow-hidden focus-within:border-blue-500 transition">
                        <button class="btn-minus px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold">-</button>
                        <input type="number" step="0.5" value="${currentVal || ''}" placeholder="0" 
                               class="stock-input w-full text-center p-2 border-none">
                        <button class="btn-plus px-3 py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold">+</button>
                    </div>
                    <div class="text-right min-w-[80px]">
                        <span class="text-[10px] text-slate-400 block uppercase font-bold tracking-wider">需叫貨</span>
                        <span class="font-bold text-blue-600 text-xl">${displayNeed}</span>
                        <span class="text-xs text-slate-500 font-medium">${item.unit || ''}</span>
                    </div>
                </div>
            `;

            // 綁定事件
            const input = div.querySelector('.stock-input');
            div.querySelector('.btn-minus').onclick = () => {
                const newVal = Math.max(0, (parseFloat(input.value) || 0) - 0.5);
                input.value = newVal;
                updateItemData(item.id, 'currentStock', newVal);
            };
            div.querySelector('.btn-plus').onclick = () => {
                const newVal = (parseFloat(input.value) || 0) + 0.5;
                input.value = newVal;
                updateItemData(item.id, 'currentStock', newVal);
            };
            input.oninput = (e) => updateItemData(item.id, 'currentStock', e.target.value);

            container.appendChild(div);
        });
        updateSummary();
    }

    function updateSummary() {
        const summaryBox = document.getElementById('summaryContent');
        const needList = Object.values(needs);
        if (needList.length === 0) {
            summaryBox.innerText = '尚無叫貨項目';
            return;
        }
        const today = new Date();
        const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
        const modeName = currentMode === 'weekday' ? '平日' : '週六';
        summaryBox.innerText = `【${dateStr} ${modeName} 叫貨清單】\n` + needList.join('\n');
    }

    // 全域導覽與動作
    window.switchTab = (tab) => {
        document.getElementById('pageInventory').classList.toggle('hidden', tab !== 'inventory');
        document.getElementById('pageSettings').classList.toggle('hidden', tab !== 'settings');
        document.getElementById('tabInventory').className = tab === 'inventory' ? 'px-8 py-3 transition tab-active' : 'px-8 py-3 transition text-slate-500';
        document.getElementById('tabSettings').className = tab === 'settings' ? 'px-8 py-3 transition tab-active' : 'px-8 py-3 transition text-slate-500';
        currentMode = 'weekday'; // 重設模式
    };

    // 事件監聽綁定
    document.getElementById('tabInventory').onclick = () => switchTab('inventory');
    document.getElementById('tabSettings').onclick = () => switchTab('settings');
    document.getElementById('btnAddItem').onclick = addItem;
    document.getElementById('btnWeekday').onclick = () => {
        currentMode = 'weekday';
        document.getElementById('btnWeekday').className = 'px-6 py-2 rounded-md font-medium btn-mode-active transition';
        document.getElementById('btnSaturday').className = 'px-6 py-2 rounded-md font-medium btn-mode-inactive transition';
        renderInventory();
    };
    document.getElementById('btnSaturday').onclick = () => {
        currentMode = 'saturday';
        document.getElementById('btnWeekday').className = 'px-6 py-2 rounded-md font-medium btn-mode-inactive transition';
        document.getElementById('btnSaturday').className = 'px-6 py-2 rounded-md font-medium btn-mode-active transition';
        renderInventory();
    };
    document.getElementById('btnCopy').onclick = () => {
        const content = document.getElementById('summaryContent').innerText;
        if (content === '尚無叫貨項目') return showToast('目前沒有叫貨項目');
        const el = document.createElement('textarea');
        el.value = content;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        showToast('已複製到剪貼簿');
    };

    function showToast(msg) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-2 rounded-full shadow-lg z-50 text-sm';
        toast.innerText = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.5s';
            setTimeout(() => document.body.removeChild(toast), 500);
        }, 2000);
    }
</script>
</body>
</html>
