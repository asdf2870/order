<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>嗯雞刀忠孝排班</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .schedule-cell { height: 45px; min-width: 55px; }
        .conflict-border { position: absolute; inset: 0; border: 2px solid #ef4444; animation: pulse 2s infinite; pointer-events: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const PASSCODE = "0418";

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [view, setView] = useState('user-unavail'); 
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authInput, setAuthInput] = useState("");
            const [loading, setLoading] = useState(true);

            const [currentDate, setCurrentDate] = useState(new Date());
            const [staff, setStaff] = useState([]);
            const [unavail, setUnavail] = useState({});
            const [schedules, setSchedules] = useState({});
            const [activePop, setActivePop] = useState(null);

            // 1. 監聽 Firebase 資料
            useEffect(() => {
                const dataRef = db.ref('shift_system_v3');
                dataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStaff(data.staff || []);
                        setUnavail(data.unavail || {});
                        setSchedules(data.schedules || {});
                    } else {
                        setStaff([{ id: '1', name: '店長', type: 'full-time', shifts: ['morning', 'evening'], order: 1 }]);
                    }
                    setLoading(false);
                });
                return () => dataRef.off();
            }, []);

            // 2. 雲端同步
            const sync = (newStaff, newUnavail, newSched) => {
                db.ref('shift_system_v3').set({
                    staff: newStaff,
                    unavail: newUnavail,
                    schedules: newSched
                });
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dates = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const getShiftColor = (timeStr) => {
                if (!timeStr) return "transparent";
                const start = parseInt(timeStr.split('-')[0]);
                if (start >= 8 && start < 16) return "rgba(250, 204, 21, 0.6)"; 
                if (start >= 16 && start < 23) return "rgba(244, 114, 182, 0.6)"; 
                return "rgba(59, 130, 246, 0.6)"; 
            };

            const exportTable = () => {
                const el = document.getElementById('export-area');
                html2canvas(el, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `班表_${year}_${month + 1}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-slate-400">雲端同步中...</div>;

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-white px-4 py-3 border-b flex justify-between items-center sticky top-0 z-[60] shadow-sm">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                <Icon name="calendar-days" className="text-indigo-600" /> 雲端排班
                            </h1>
                            <nav className="flex bg-slate-100 p-1 rounded-xl scale-90">
                                <button onClick={() => setView('user-unavail')} className={`px-4 py-1.5 rounded-lg text-sm font-bold ${view === 'user-unavail' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>畫休</button>
                                <button onClick={() => isAdminAuthenticated ? setView('admin-schedule') : setShowAuthModal(true)} className={`px-4 py-1.5 rounded-lg text-sm font-bold ${view === 'admin-schedule' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>排班</button>
                                <button onClick={() => isAdminAuthenticated ? setView('staff-manage') : setShowAuthModal(true)} className={`px-4 py-1.5 rounded-lg text-sm font-bold ${view === 'staff-manage' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>人員</button>
                            </nav>
                        </div>
                        <div className="flex gap-2 items-center">
                            <span className="font-black text-xs text-slate-400">{month + 1}月</span>
                            <button onClick={() => isAdminAuthenticated ? setIsAdminAuthenticated(false) : setShowAuthModal(true)} className={`p-2 rounded-xl border ${isAdminAuthenticated ? 'bg-emerald-50 text-emerald-600 border-emerald-100' : 'bg-rose-50 text-rose-500'}`}>
                                <Icon name={isAdminAuthenticated ? "unlock" : "lock"} size={16}/>
                            </button>
                        </div>
                    </header>

                    <main className="flex-1 p-4">
                        {view === 'admin-schedule' && (
                            <div className="bg-white rounded-3xl border shadow-xl overflow-hidden flex flex-col">
                                <div className="p-4 border-b flex justify-between bg-slate-50">
                                    <div className="flex gap-2">
                                        <button onClick={() => setCurrentDate(new Date(year, month - 1))} className="p-2 bg-white border rounded-xl"><Icon name="chevron-left" size={16}/></button>
                                        <button onClick={() => setCurrentDate(new Date(year, month + 1))} className="p-2 bg-white border rounded-xl"><Icon name="chevron-right" size={16}/></button>
                                    </div>
                                    <button onClick={exportTable} className="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg">
                                        <Icon name="download" size={14}/> 導出圖片
                                    </button>
                                </div>
                                <div id="export-area" className="overflow-auto">
                                    <table className="w-full border-collapse">
                                        <thead>
                                            <tr className="bg-slate-100">
                                                <th className="sticky left-0 bg-slate-100 p-2 border-r z-10 min-w-[80px] text-xs font-black">人員</th>
                                                {dates.map(d => (
                                                    <th key={d} className="p-2 border-r min-w-[50px] text-center">
                                                        <div className="text-xs font-black">{d}</div>
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {staff.sort((a,b)=>a.order-b.order).map(s => (
                                                <tr key={s.id} className="border-b">
                                                    <td className="sticky left-0 bg-white p-2 border-r text-center font-bold text-xs shadow-sm">{s.name}</td>
                                                    {dates.map(d => {
                                                        const shift = schedules[`${s.id}-${d}`];
                                                        const isOff = unavail[`${s.id}-${year}-${month+1}-${d}`]?.full;
                                                        return (
                                                            <td key={d} onClick={() => isAdminAuthenticated && setActivePop({type:'schedule', staffId: s.id, day: d})} 
                                                                className={`border-r schedule-cell relative cursor-pointer ${isOff ? 'bg-slate-200' : ''}`}
                                                                style={{ backgroundColor: getShiftColor(shift) }}>
                                                                {shift && <span className="text-sm font-black text-slate-900">{shift.split('-')[0]}</span>}
                                                                {isOff && !shift && <span className="text-[10px] font-black text-slate-400 text-center block">休</span>}
                                                                {shift && isOff && <div className="conflict-border"></div>}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'user-unavail' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {staff.sort((a,b)=>a.order-b.order).map(s => (
                                    <div key={s.id} className="bg-white rounded-3xl border p-4 shadow-sm">
                                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                                            <span className="font-black text-slate-800">{s.name}</span>
                                            <span className="text-[10px] bg-slate-100 px-2 py-1 rounded-lg text-slate-500 font-bold">畫休模式</span>
                                        </div>
                                        <div className="calendar-grid">
                                            {dates.map(d => {
                                                const k = `${s.id}-${year}-${month+1}-${d}`;
                                                const isOff = unavail[k]?.full;
                                                return (
                                                    <button key={d} onClick={() => {
                                                        const newUnavail = {...unavail, [k]: {full: !isOff}};
                                                        sync(staff, newUnavail, schedules);
                                                    }} className={`aspect-square rounded-xl border flex items-center justify-center font-black text-xs transition ${isOff ? 'bg-rose-500 border-rose-600 text-white' : 'bg-slate-50 border-slate-100 text-slate-300'}`}>
                                                        {d}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
