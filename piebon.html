<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>嗯機刀忠孝店排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .schedule-cell { height: 40px; min-width: 80px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const PASSCODE = "0418";

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            // --- 狀態管理 ---
            const [view, setView] = useState('user-unavail'); 
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authCallback, setAuthCallback] = useState(null); 
            const [authInput, setAuthInput] = useState("");

            const [currentDate, setCurrentDate] = useState(new Date());
            const [isUnavailLocked, setIsUnavailLocked] = useState(false);
            const [isScheduleLocked, setIsScheduleLocked] = useState(false);
            const [hideUnavailMarker, setHideUnavailMarker] = useState(false);
            const [customRedDays, setCustomRedDays] = useState({});

            const [staff, setStaff] = useState(() => JSON.parse(localStorage.getItem('v2_staff')) || [
                { id: '1', name: '王小明', type: 'full-time', shifts: ['morning', 'evening'], note: '', order: 1 }
            ]);
            const [unavail, setUnavail] = useState(() => JSON.parse(localStorage.getItem('v2_unavail')) || {});
            const [schedules, setSchedules] = useState(() => JSON.parse(localStorage.getItem('v2_schedules')) || {});

            const [activePop, setActivePop] = useState(null); 

            // --- 資料持久化 ---
            useEffect(() => {
                localStorage.setItem('v2_staff', JSON.stringify(staff));
                localStorage.setItem('v2_unavail', JSON.stringify(unavail));
                localStorage.setItem('v2_schedules', JSON.stringify(schedules));
            }, [staff, unavail, schedules]);

            // --- 密碼驗證邏輯 ---
            const triggerAuth = (successCallback) => {
                if (isAdminAuthenticated) {
                    successCallback();
                } else {
                    setAuthCallback(() => successCallback);
                    setShowAuthModal(true);
                    setAuthInput("");
                }
            };

            const handleAuthSubmit = () => {
                if (authInput === PASSCODE) {
                    setIsAdminAuthenticated(true);
                    setShowAuthModal(false);
                    if (authCallback) authCallback();
                } else {
                    alert("密碼錯誤，請重試");
                    setAuthInput("");
                }
            };

            // --- 日期計算 ---
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay(); 
            const adjustedStartDay = startDay === 0 ? 6 : startDay - 1; 
            const dates = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const isRedDate = (d) => {
                const dayOfWeek = new Date(year, month, d).getDay();
                const key = `${year}-${month + 1}-${d}`;
                return customRedDays[key] || dayOfWeek === 0 || dayOfWeek === 5 || dayOfWeek === 6; 
            };

            // --- 時段解析與配色 ---
            const parseTime = (str) => {
                if (!str || typeof str !== 'string') return null;
                const match = str.match(/(\d+)-(\d+)/);
                if (!match) return null;
                return { start: parseInt(match[1]), end: parseInt(match[2]) };
            };

            const getShiftColor = (timeStr) => {
                const time = parseTime(timeStr);
                if (!time) return "transparent";
                const { start } = time;
                if (start >= 8 && start < 16) return "rgba(250, 204, 21, 0.7)"; // 早-黃
                if (start >= 16 && start < 23) return "rgba(244, 114, 182, 0.7)"; // 晚-粉
                return "rgba(59, 130, 246, 0.7)"; // 夜-藍
            };

            // --- 統計數據 ---
            const stats = useMemo(() => {
                const res = {};
                staff.forEach(s => {
                    let hours = 0; let days = 0;
                    dates.forEach(d => {
                        const shift = schedules[`${s.id}-${d}`];
                        if (shift) {
                            const t = parseTime(shift);
                            if (t) {
                                let diff = t.end - t.start;
                                if (diff < 0) diff += 24;
                                hours += diff;
                                days++;
                            }
                        }
                    });
                    res[s.id] = { hours, days };
                });
                return res;
            }, [schedules, staff, dates]);

            // --- 截圖導出 ---
            const exportTable = () => {
                const el = document.getElementById('export-area');
                html2canvas(el).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `班表_${year}_${month + 1}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };

            return (
                <div className="min-h-screen flex flex-col max-w-[1600px] mx-auto shadow-2xl bg-slate-50">
                    {/* Header */}
                    <header className="bg-white px-6 py-4 border-b flex flex-wrap justify-between items-center sticky top-0 z-[60] shadow-sm gap-4">
                        <div className="flex items-center gap-6">
                            <h1 className="text-2xl font-black text-slate-800 flex items-center gap-2">
                                <Icon name="calendar-check" className="text-blue-600" />
                                智慧排班
                            </h1>
                            <nav className="flex bg-slate-100 p-1.5 rounded-2xl">
                                <button onClick={() => setView('user-unavail')} className={`px-5 py-2 rounded-xl text-sm font-black transition ${view === 'user-unavail' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>畫休模式</button>
                                <button onClick={() => triggerAuth(() => setView('admin-schedule'))} className={`px-5 py-2 rounded-xl text-sm font-black transition ${view === 'admin-schedule' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>管理排班</button>
                                <button onClick={() => triggerAuth(() => setView('staff-manage'))} className={`px-5 py-2 rounded-xl text-sm font-black transition ${view === 'staff-manage' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>人員管理</button>
                            </nav>
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="flex items-center bg-slate-100 rounded-xl px-3 py-1.5 gap-3 border border-slate-200">
                                <button onClick={() => setCurrentDate(new Date(year, month - 1))} className="p-1 hover:bg-white rounded-lg transition shadow-sm"><Icon name="chevron-left" size={18}/></button>
                                <span className="font-black text-slate-700 min-w-[80px] text-center">{year} / {month + 1}月</span>
                                <button onClick={() => setCurrentDate(new Date(year, month + 1))} className="p-1 hover:bg-white rounded-lg transition shadow-sm"><Icon name="chevron-right" size={18}/></button>
                            </div>
                            {isAdminAuthenticated && (
                                <button onClick={() => setIsAdminAuthenticated(false)} className="bg-rose-50 text-rose-500 p-2.5 rounded-xl border border-rose-100 hover:bg-rose-500 hover:text-white transition group" title="管理員登出">
                                    <Icon name="log-out" size={20}/>
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 p-6 overflow-x-hidden">
                        {/* 統計列 */}
                        {view === 'admin-schedule' && (
                            <div className="mb-6 flex gap-4 overflow-x-auto no-scrollbar pb-2">
                                {staff.sort((a,b)=>a.order-b.order).map(s => (
                                    <div key={s.id} className="bg-white border-2 border-slate-100 rounded-3xl px-5 py-3 shadow-sm flex flex-col min-w-[140px] flex-shrink-0">
                                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">{s.name}</span>
                                        <div className="flex justify-between items-end">
                                            <span className="text-xl font-black text-blue-600">{stats[s.id]?.hours}h</span>
                                            <span className="text-xs font-bold text-slate-400">{stats[s.id]?.days}天</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 人員管理 */}
                        {view === 'staff-manage' && (
                            <div className="max-w-5xl mx-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-black text-slate-800">人員名單管理</h2>
                                    <button onClick={() => setStaff([...staff, { id: Date.now().toString(), name: '姓名', type: 'part-time', shifts: [], note: '', order: staff.length + 1 }])} className="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 shadow-lg shadow-blue-200 active:scale-95 transition">
                                        <Icon name="user-plus" size={18}/> 新增人員
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    {staff.sort((a,b)=>a.order-b.order).map(s => (
                                        <div key={s.id} className="bg-white rounded-3xl p-5 border-2 border-slate-100 shadow-sm flex flex-wrap items-center gap-6">
                                            <div className="w-12">
                                                <input type="number" className="w-full bg-slate-50 border rounded-xl p-2 text-center font-black" value={s.order} onChange={(e)=>setStaff(staff.map(st=>st.id===s.id?{...st, order: parseInt(e.target.value)||0}:st))}/>
                                            </div>
                                            <input className="text-lg font-black bg-transparent border-b-2 border-slate-100 focus:border-blue-500 outline-none w-32" value={s.name} onChange={(e)=>setStaff(staff.map(st=>st.id===s.id?{...st, name: e.target.value}:st))}/>
                                            
                                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                                <button onClick={()=>setStaff(staff.map(st=>st.id===s.id?{...st, type:'full-time'}:st))} className={`px-4 py-1.5 rounded-lg text-xs font-black transition ${s.type==='full-time'?'bg-white shadow text-blue-600':'text-slate-400'}`}>正職</button>
                                                <button onClick={()=>setStaff(staff.map(st=>st.id===s.id?{...st, type:'part-time'}:st))} className={`px-4 py-1.5 rounded-lg text-xs font-black transition ${s.type==='part-time'?'bg-white shadow text-blue-600':'text-slate-400'}`}>兼職</button>
                                            </div>

                                            <div className="flex gap-1.5">
                                                {['morning','evening','night'].map(sh => (
                                                    <button key={sh} 
                                                        onClick={()=>{
                                                            const newSh = s.shifts.includes(sh) ? s.shifts.filter(x=>x!==sh) : [...s.shifts, sh];
                                                            setStaff(staff.map(st=>st.id===s.id?{...st, shifts:newSh}:st));
                                                        }}
                                                        className={`w-9 h-9 rounded-xl text-xs font-black flex items-center justify-center border-2 transition ${s.shifts.includes(sh)?'bg-slate-800 border-slate-800 text-white':'bg-white border-slate-100 text-slate-300'}`}
                                                    >
                                                        {sh === 'morning' ? '早' : sh === 'evening' ? '晚' : '夜'}
                                                    </button>
                                                ))}
                                            </div>

                                            <input placeholder="人員備註..." className="flex-1 bg-slate-50 border border-slate-100 p-2.5 rounded-xl text-sm font-bold" value={s.note} onChange={(e)=>setStaff(staff.map(st=>st.id===s.id?{...st, note: e.target.value}:st))}/>
                                            
                                            <button onClick={()=>setStaff(staff.filter(st=>st.id!==s.id))} className="text-slate-300 hover:text-rose-500 transition p-2"><Icon name="trash-2"/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 畫休模式 */}
                        {view === 'user-unavail' && (
                            <div className="space-y-6">
                                <div className="flex justify-between items-center bg-white p-5 rounded-[2rem] shadow-sm border-2 border-slate-100">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-3.5 h-3.5 rounded-full ${isUnavailLocked ? 'bg-rose-500 shadow-[0_0_10px_rgba(244,63,94,0.5)]' : 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]'}`}></div>
                                        <span className="font-black text-slate-700">{isUnavailLocked ? '畫休功能已鎖定 (暫停修改)' : '自由畫休中 (歡迎填寫)'}</span>
                                    </div>
                                    <button onClick={() => triggerAuth(() => setIsUnavailLocked(!isUnavailLocked))} className={`px-6 py-2.5 rounded-2xl font-black text-xs flex items-center gap-2 transition shadow-lg ${isUnavailLocked ? 'bg-emerald-500 text-white shadow-emerald-100' : 'bg-slate-800 text-white shadow-slate-200'}`}>
                                        <Icon name={isUnavailLocked ? "unlock" : "lock"} size={14}/> {isUnavailLocked ? '解鎖畫休功能' : '一鍵鎖定功能'}
                                    </button>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
                                    {staff.sort((a,b)=>a.order-b.order).map(s => (
                                        <div key={s.id} className="bg-white rounded-[2.5rem] border-2 border-slate-100 shadow-sm overflow-hidden flex flex-col">
                                            <div className="bg-slate-50/50 px-6 py-4 border-b flex justify-between items-center">
                                                <div>
                                                    <span className="text-lg font-black block text-slate-800">{s.name}</span>
                                                    <span className="text-[10px] font-black text-slate-400 tracking-widest uppercase">
                                                        {s.type === 'full-time' ? '正職' : '兼職'} · {s.shifts.map(sh=>sh==='morning'?'早':sh==='evening'?'晚':'夜').join('')}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="p-4">
                                                <div className="calendar-grid mb-2">
                                                    {['一','二','三','四','五','六','日'].map(w => (
                                                        <div key={w} className={`text-center text-[10px] font-black py-1 ${w==='五'||w==='六'||w==='日' ? 'text-rose-500':'text-slate-400'}`}>{w}</div>
                                                    ))}
                                                </div>
                                                <div className="calendar-grid">
                                                    {Array.from({ length: adjustedStartDay }).map((_, i) => <div key={i} />)}
                                                    {dates.map(d => {
                                                        const key = `${s.id}-${year}-${month+1}-${d}`;
                                                        const data = unavail[key];
                                                        const isRed = isRedDate(d);
                                                        return (
                                                            <button 
                                                                key={d} 
                                                                disabled={isUnavailLocked}
                                                                onClick={() => setActivePop({ type: 'unavail', staffId: s.id, day: d })}
                                                                className={`aspect-square rounded-2xl flex flex-col items-center justify-center relative transition border-2 group
                                                                    ${isRed ? 'bg-rose-50 border-rose-50 hover:border-rose-200' : 'bg-white border-slate-50 hover:border-blue-100'}
                                                                    ${isUnavailLocked ? 'opacity-60 cursor-not-allowed grayscale-[0.5]' : 'hover:scale-110 hover:shadow-xl active:scale-95'}
                                                                `}
                                                            >
                                                                <span className={`absolute top-1.5 left-2 text-[10px] font-black ${isRed ? 'text-rose-500' : 'text-slate-300 group-hover:text-blue-400'}`}>{d}</span>
                                                                {data && (
                                                                    <div className="flex flex-col items-center leading-none mt-1">
                                                                        {data.full && <span className="text-[12px] font-black text-slate-700 bg-slate-200/30 px-1 rounded">休</span>}
                                                                        <div className="flex gap-0.5 mt-0.5">
                                                                            {data.morning && <div className="w-1.5 h-1.5 rounded-full bg-amber-400"></div>}
                                                                            {data.evening && <div className="w-1.5 h-1.5 rounded-full bg-rose-600"></div>}
                                                                            {data.night && <div className="w-1.5 h-1.5 rounded-full bg-purple-600"></div>}
                                                                        </div>
                                                                        {(data.canUntil || data.noAfter) && <span className="text-[9px] font-black text-emerald-600 mt-0.5 leading-none">限</span>}
                                                                    </div>
                                                                )}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 管理排班 */}
                        {view === 'admin-schedule' && (
                            <div className="bg-white rounded-[3rem] border-2 border-slate-100 shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
                                <div className="p-6 border-b flex justify-between items-center bg-slate-50/50 sticky top-0 z-40 backdrop-blur-md">
                                    <div className="flex items-center gap-4">
                                        <h2 className="text-xl font-black text-slate-800 flex items-center gap-2"><Icon name="grid"/> 排班主控台</h2>
                                        <button onClick={()=>setHideUnavailMarker(!hideUnavailMarker)} className={`p-2.5 rounded-xl transition ${hideUnavailMarker ? 'bg-slate-800 text-white shadow-lg' : 'bg-white text-slate-400 border border-slate-100 shadow-sm'}`} title="顯示/隱藏底層畫休標記">
                                            <Icon name={hideUnavailMarker ? "eye-off" : "eye"} size={20}/>
                                        </button>
                                        <div className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl border border-slate-100 shadow-sm">
                                            <input type="checkbox" id="lock-sched" checked={isScheduleLocked} onChange={() => triggerAuth(() => setIsScheduleLocked(!isScheduleLocked))} className="w-4 h-4 accent-blue-600 cursor-pointer"/>
                                            <label htmlFor="lock-sched" className="text-xs font-black text-slate-600 cursor-pointer">鎖定排班內容</label>
                                        </div>
                                    </div>
                                    <button onClick={exportTable} className="bg-emerald-500 text-white px-6 py-2.5 rounded-2xl font-black flex items-center gap-2 shadow-lg shadow-emerald-100 hover:scale-105 active:scale-95 transition">
                                        <Icon name="download" size={16}/> 導出圖檔
                                    </button>
                                </div>

                                <div id="export-area" className="flex-1 overflow-auto no-scrollbar relative">
                                    <table className="w-full border-collapse">
                                        <thead className="sticky top-0 z-30 bg-white">
                                            <tr>
                                                <th className="sticky left-0 z-40 bg-slate-50 p-2 border-r border-b min-w-[120px] text-[10px] font-black uppercase text-slate-400">員工名稱</th>
                                                {dates.map(d => (
                                                    <th key={d} onClick={()=> {
                                                        const k = `${year}-${month+1}-${d}`;
                                                        setCustomRedDays({...customRedDays, [k]: !customRedDays[k]});
                                                    }} className={`p-1 border-b border-r min-w-[85px] cursor-pointer hover:bg-blue-50 transition group ${isRedDate(d)?'bg-rose-50':'bg-white'}`}>
                                                        <div className={`text-base font-black ${isRedDate(d)?'text-rose-600':'text-slate-800'}`}>{d}</div>
                                                        <div className={`text-[10px] font-bold ${isRedDate(d)?'text-rose-400':'text-slate-300 group-hover:text-blue-300'}`}>{['日','一','二','三','四','五','六'][new Date(year, month, d).getDay()]}</div>
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {staff.sort((a,b)=>a.order-b.order).map(s => (
                                                <tr key={s.id} className="schedule-cell group">
                                                    <td className="sticky left-0 z-20 bg-white p-3 border-r border-b text-center shadow-[4px_0_10px_rgba(0,0,0,0.02)]">
                                                        <span className="font-black text-slate-700 text-sm">{s.name}</span>
                                                    </td>
                                                    {dates.map(d => {
                                                        const sKey = `${s.id}-${d}`;
                                                        const uKey = `${s.id}-${year}-${month+1}-${d}`;
                                                        const shift = schedules[sKey];
                                                        const uData = unavail[uKey];
                                                        
                                                        // 智慧衝突偵測
                                                        let isConflict = false;
                                                        if (shift && uData) {
                                                            const t = parseTime(shift);
                                                            if (uData.full) isConflict = true;
                                                            if (uData.canUntil && t.end > parseInt(uData.canUntil)) isConflict = true;
                                                            if (uData.noAfter && t.start < parseInt(uData.noAfter)) isConflict = true;
                                                            if (uData.morning && t.start < 16) isConflict = true;
                                                            if (uData.evening && (t.start >= 16 && t.start < 23)) isConflict = true;
                                                            if (uData.night && t.start >= 23) isConflict = true;
                                                        }

                                                        return (
                                                            <td key={d} onClick={()=>!isScheduleLocked && setActivePop({type:'schedule', staffId: s.id, day: d})} className={`border-r border-b p-0 relative transition group h-10 ${isScheduleLocked ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-slate-100'}`}>
                                                                {/* 畫休底色 */}
                                                                {uData && !hideUnavailMarker && (
                                                                    <div className="absolute inset-0 opacity-30 z-0 flex items-center justify-center font-black text-lg" style={{
                                                                        backgroundColor: uData.full ? 'rgba(71,85,105,1)' : (uData.morning ? 'rgba(250,204,21,1)' : (uData.evening ? 'rgba(153,27,27,1)' : (uData.night ? 'rgba(126,34,206,1)' : 'rgba(34,197,94,1)')))
                                                                    }}>
                                                                        {uData.full && <span className="scale-125">休</span>}
                                                                    </div>
                                                                )}
                                                                {/* 排班文字 */}
                                                                {shift && (
                                                                    <div className="absolute inset-0 z-10 flex items-center justify-center transition-all group-hover:scale-110" style={{ backgroundColor: getShiftColor(shift) }}>
                                                                        <span className="text-xl font-black text-slate-900 tracking-tighter drop-shadow-sm">{shift}</span>
                                                                        {isConflict && <div className="absolute top-1 right-1 w-2.5 h-2.5 bg-rose-600 rounded-full border-2 border-white shadow-sm animate-pulse"></div>}
                                                                        {isConflict && <span className="absolute bottom-0 text-[8px] font-black text-rose-700 bg-white/90 px-1 rounded-t border-t border-x border-rose-200 shadow-sm">衝突</span>}
                                                                    </div>
                                                                )}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* --- React Auth Modal --- */}
                    {showAuthModal && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[200] flex items-center justify-center p-6 animate-in fade-in duration-300">
                            <div className="bg-white rounded-[3rem] w-full max-w-sm p-10 shadow-2xl flex flex-col items-center border-2 border-white transform transition-all scale-105">
                                <div className="w-20 h-20 bg-blue-50 rounded-[2rem] flex items-center justify-center text-blue-600 mb-8 shadow-inner">
                                    <Icon name="shield-check" size={40}/>
                                </div>
                                <h3 className="text-2xl font-black text-slate-800 mb-3 tracking-tight">管理員驗證</h3>
                                <p className="text-slate-400 text-sm mb-10 font-bold text-center leading-relaxed">此功能僅限管理人員操作<br/>請輸入 4 位數驗證密碼</p>
                                
                                <div className="relative w-full mb-8">
                                    <input 
                                        type="password" 
                                        autoFocus
                                        className="w-full bg-slate-100 border-2 border-transparent focus:border-blue-500 rounded-3xl p-5 text-center text-4xl font-black tracking-[0.5em] outline-none transition-all placeholder-slate-200"
                                        placeholder="••••"
                                        value={authInput}
                                        onChange={(e)=>setAuthInput(e.target.value)}
                                        onKeyDown={(e)=>e.key==='Enter' && handleAuthSubmit()}
                                    />
                                </div>
                                
                                <div className="flex gap-4 w-full">
                                    <button onClick={()=>{setShowAuthModal(false); setAuthCallback(null);}} className="flex-1 py-4 font-black text-slate-400 hover:text-slate-600 transition">取消操作</button>
                                    <button onClick={handleAuthSubmit} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl shadow-blue-200 hover:bg-blue-700 active:scale-95 transition">確認進入</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- 畫休設定 Popover --- */}
                    {activePop?.type === 'unavail' && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center p-4 overflow-y-auto" onClick={()=>setActivePop(null)}>
                            <div className="bg-white rounded-[3rem] w-full max-w-[360px] shadow-2xl overflow-hidden animate-in zoom-in duration-200" onClick={e=>e.stopPropagation()}>
                                <div className="bg-slate-50 p-6 border-b flex justify-between items-center">
                                    <div>
                                        <span className="font-black text-lg block">{activePop.day}日 畫休設定</span>
                                        <span className="text-[10px] font-black text-slate-400 tracking-widest">{staff.find(st=>st.id===activePop.staffId).name} 的個人申請</span>
                                    </div>
                                    <button onClick={()=>setActivePop(null)} className="p-2 hover:bg-slate-200 rounded-xl transition"><Icon name="x"/></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <button onClick={()=>{
                                        const k = `${activePop.staffId}-${year}-${month+1}-${activePop.day}`;
                                        const d = unavail[k] || {};
                                        setUnavail({...unavail, [k]: {...d, full: !d.full}});
                                    }} className={`w-full py-4 rounded-2xl font-black border-2 transition ${unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]?.full ? 'bg-slate-800 border-slate-800 text-white shadow-xl' : 'bg-slate-50 border-transparent text-slate-400 hover:bg-slate-100'}`}>全天休假</button>
                                    
                                    <div className="grid grid-cols-3 gap-3">
                                        {['morning', 'evening', 'night'].map(type => {
                                            const s = staff.find(st=>st.id===activePop.staffId);
                                            if (!s.shifts.includes(type)) return null;
                                            const k = `${activePop.staffId}-${year}-${month+1}-${activePop.day}`;
                                            const active = unavail[k]?.[type];
                                            const label = type === 'morning' ? '早休' : (type === 'evening' ? '晚休' : '夜休');
                                            const activeStyle = type === 'morning' ? 'bg-amber-400 border-amber-400 text-white' : (type === 'evening' ? 'bg-rose-600 border-rose-600 text-white' : 'bg-purple-600 border-purple-600 text-white');
                                            return (
                                                <button key={type} onClick={()=>{
                                                    const d = unavail[k] || {};
                                                    setUnavail({...unavail, [k]: {...d, [type]: !d[type]}});
                                                }} className={`py-2.5 rounded-2xl text-[13px] font-black border-2 transition ${active ? activeStyle : 'bg-slate-50 border-transparent text-slate-300'}`}>
                                                    {label}
                                                </button>
                                            );
                                        })}
                                    </div>

                                    <div className="flex gap-4">
                                        <div className="flex-1">
                                            <div className="text-[10px] font-black text-slate-400 mb-1 ml-1">可到幾點</div>
                                            <div className="relative">
                                                <input type="number" placeholder="點" className="w-full bg-slate-100 p-3.5 rounded-2xl font-black text-base outline-none border-2 border-transparent focus:border-blue-500 transition" value={unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]?.canUntil || ""} onChange={(e)=>setUnavail({...unavail, [`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]: {...(unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]||{}), canUntil: e.target.value}})}/>
                                                {unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]?.canUntil && <span className="absolute -bottom-5 left-1 text-[9px] font-black text-blue-500 whitespace-nowrap">可到{unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].canUntil}點</span>}
                                            </div>
                                        </div>
                                        <div className="flex-1">
                                            <div className="text-[10px] font-black text-slate-400 mb-1 ml-1">幾點後不可</div>
                                            <div className="relative">
                                                <input type="number" placeholder="點" className="w-full bg-slate-100 p-3.5 rounded-2xl font-black text-base outline-none border-2 border-transparent focus:border-rose-500 transition" value={unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]?.noAfter || ""} onChange={(e)=>setUnavail({...unavail, [`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]: {...(unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]||{}), noAfter: e.target.value}})}/>
                                                {unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]?.noAfter && <span className="absolute -bottom-5 left-1 text-[9px] font-black text-rose-500 whitespace-nowrap">{unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].noAfter}點後不行</span>}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="pt-2">
                                        <div className="text-[10px] font-black text-slate-400 mb-1 ml-1">畫休備註</div>
                                        <textarea placeholder="請輸入備註內容..." className="w-full bg-slate-100 p-4 rounded-2xl text-xs font-bold border-none outline-none h-20 placeholder-slate-300 focus:bg-white focus:ring-2 ring-blue-50 transition" value={unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]?.note || ""} onChange={(e)=>setUnavail({...unavail, [`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]: {...(unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`]||{}), note: e.target.value}})}/>
                                    </div>
                                    
                                    <button onClick={()=>setActivePop(null)} className="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-black shadow-xl shadow-blue-100 active:scale-95 transition">完成畫休申請</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- 管理排班設定 Popover --- */}
                    {activePop?.type === 'schedule' && (
                        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[150] flex items-center justify-center p-4" onClick={()=>setActivePop(null)}>
                            <div className="bg-white rounded-[3rem] w-full max-w-[380px] shadow-2xl overflow-hidden animate-in slide-in-from-bottom-10 duration-200" onClick={e=>e.stopPropagation()}>
                                <div className="bg-slate-50 p-6 border-b flex flex-col gap-1">
                                    <div className="flex justify-between items-center">
                                        <span className="font-black text-xl text-slate-800">{staff.find(st=>st.id===activePop.staffId).name} <span className="text-slate-300 mx-1">/</span> {activePop.day}日</span>
                                        <button onClick={()=>setActivePop(null)} className="p-2 hover:bg-slate-200 rounded-xl transition"><Icon name="x"/></button>
                                    </div>
                                    {unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`] && (
                                        <div className="text-[10px] font-black text-rose-500 bg-rose-50 px-3 py-1.5 rounded-xl border border-rose-100 mt-2 flex items-center gap-2">
                                            <Icon name="info" size={14}/>
                                            畫休：{unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].full ? '全天休 ' : ''}
                                            {unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].canUntil ? `可到${unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].canUntil}點 ` : ''}
                                            {unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].noAfter ? `${unavail[`${activePop.staffId}-${year}-${month+1}-${activePop.day}`].noAfter}點後不 ` : ''}
                                        </div>
                                    )}
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-2 gap-3">
                                        {(staff.find(st=>st.id===activePop.staffId).type === 'full-time' ? ['10-17', '16-23'] : 
                                            [
                                                ...(staff.find(st=>st.id===activePop.staffId).shifts.includes('morning') ? ['10-16', '12-16', '12-20'] : []),
                                                ...(staff.find(st=>st.id===activePop.staffId).shifts.includes('evening') ? ['12-20', '17-23', '18-23'] : []),
                                                ...(staff.find(st=>st.id===activePop.staffId).shifts.includes('night') ? ['23-05', '24-05'] : [])
                                            ]
                                        ).map(t => (
                                            <button key={t} onClick={()=>{
                                                setSchedules({...schedules, [`${activePop.staffId}-${activePop.day}`]: t});
                                                setActivePop(null);
                                            }} className={`py-4 rounded-2xl font-black border-2 transition ${schedules[`${activePop.staffId}-${activePop.day}`] === t ? 'bg-slate-800 border-slate-800 text-white shadow-lg' : 'bg-slate-50 border-transparent text-slate-500 hover:bg-slate-100'}`}>{t}</button>
                                        ))}
                                    </div>
                                    
                                    <div className="flex gap-2">
                                        <input 
                                            placeholder="自定義 (例: 13-21)" 
                                            className="flex-1 bg-slate-100 p-4 rounded-2xl font-black text-sm outline-none border-2 border-transparent focus:border-blue-500 placeholder-slate-300 transition"
                                            value={schedules[`${activePop.staffId}-${activePop.day}`] || ""}
                                            onChange={(e) => setSchedules({...schedules, [`${activePop.staffId}-${activePop.day}`]: e.target.value})}
                                            onKeyDown={(e) => e.key === 'Enter' && setActivePop(null)}
                                        />
                                        <button onClick={()=>{
                                            setSchedules({...schedules, [`${activePop.staffId}-${activePop.day}`]: ""});
                                            setActivePop(null);
                                        }} className="bg-rose-50 text-rose-500 px-5 py-2 rounded-2xl text-xs font-black border border-rose-100">清除</button>
                                    </div>
                                    
                                    <button onClick={()=>setActivePop(null)} className="w-full py-5 bg-blue-600 text-white rounded-[1.5rem] font-black shadow-xl shadow-blue-100 active:scale-95 transition">確認排班</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
