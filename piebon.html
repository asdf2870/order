<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>智能排班系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8FAFC; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        th, td { border: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const ADMIN_PASSCODE = "0418";
        const weekNames = ['一', '二', '三', '四', '五', '六', '日'];

        const App = () => {
            const [currentDate] = useState(new Date());
            const [view, setView] = useState('admin-view');
            const [isLocked, setIsLocked] = useState(true);
            const [loading, setLoading] = useState(true);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [authPassword, setAuthPassword] = useState("");

            const [staff, setStaff] = useState([]);
            const [unavailabilities, setUnavailabilities] = useState({});
            const [schedules, setSchedules] = useState({});
            const [popover, setPopover] = useState(null);

            // 1. 初始化讀取 Firebase
            useEffect(() => {
                const dataRef = db.ref('shift_system');
                dataRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStaff(data.staff || []);
                        setUnavailabilities(data.unavailabilities || {});
                        setSchedules(data.schedules || {});
                    } else {
                        // 如果雲端完全沒資料，先給一個預設店長，否則格子出不來
                        setStaff([{ id: '1', name: '店長', type: 'full-time', shifts: ['morning', 'evening'], position: '管理員', order: 1 }]);
                    }
                    setLoading(false);
                });
                return () => dataRef.off();
            }, []);

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysCount = new Date(year, month + 1, 0).getDate();
            const dates = Array.from({ length: daysCount }, (_, i) => i + 1);

            const syncToCloud = (newStaff, newUnavail, newSched) => {
                db.ref('shift_system').set({
                    staff: newStaff,
                    unavailabilities: newUnavail,
                    schedules: newSched
                });
            };

            const handleAuthSubmit = () => {
                if (authPassword === ADMIN_PASSCODE) {
                    setIsLocked(false);
                    setShowAuthModal(false);
                } else { alert("密碼錯誤"); }
                setAuthPassword("");
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-400">連線資料庫中...</div>;

            return (
                <div className="min-h-screen pb-10">
                    <nav className="bg-white p-4 border-b flex justify-between items-center sticky top-0 z-50">
                        <div className="font-black text-indigo-600 text-lg">智能排班</div>
                        <div className="flex gap-2">
                            <button onClick={() => setView('staff-view')} className={`px-3 py-1 rounded-lg text-xs font-bold ${view === 'staff-view' ? 'bg-indigo-600 text-white' : 'bg-slate-100'}`}>員工畫休</button>
                            <button onClick={() => setView('admin-view')} className={`px-3 py-1 rounded-lg text-xs font-bold ${view === 'admin-view' ? 'bg-indigo-600 text-white' : 'bg-slate-100'}`}>排班表</button>
                            <button onClick={() => isLocked ? setShowAuthModal(true) : setIsLocked(true)} className={`px-3 py-1 rounded-lg text-xs font-bold ${isLocked ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>
                                {isLocked ? '解鎖' : '鎖定中'}
                            </button>
                        </div>
                    </nav>

                    <main className="p-4">
                        {view === 'admin-view' && (
                            <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
                                <table className="w-full text-xs text-center border-collapse">
                                    <thead>
                                        <tr className="bg-slate-50">
                                            <th className="p-2 min-w-[80px] sticky left-0 bg-slate-50 z-10">員工</th>
                                            {dates.map(d => (
                                                <th key={d} className="p-2 min-w-[45px]">{d}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {staff.sort((a,b)=>a.order-b.order).map(s => (
                                            <tr key={s.id}>
                                                <td className="p-2 font-bold sticky left-0 bg-white border-r">{s.name}</td>
                                                {dates.map(d => {
                                                    const shift = schedules[`${s.id}-${d}`];
                                                    return (
                                                        <td key={d} 
                                                            onClick={() => !isLocked && setPopover({type:'sched', staff:s, date:d})}
                                                            className={`p-2 h-10 cursor-pointer hover:bg-slate-50 ${shift ? 'bg-indigo-50 text-indigo-600 font-bold' : ''}`}>
                                                            {shift || ''}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}

                        {view === 'staff-view' && (
                            <div className="grid gap-6">
                                {staff.map(s => (
                                    <div key={s.id} className="bg-white p-4 rounded-2xl border">
                                        <div className="font-black mb-3">{s.name} - 畫休</div>
                                        <div className="grid grid-cols-7 gap-1">
                                            {dates.map(d => {
                                                const key = `${s.id}-${year}-${month}-${d}`;
                                                const isOff = unavailabilities[key]?.types?.includes('全天休');
                                                return (
                                                    <button key={d} 
                                                        onClick={() => {
                                                            const newUnavail = {...unavailabilities, [key]: {types: isOff ? [] : ['全天休']}};
                                                            syncToCloud(staff, newUnavail, schedules);
                                                        }}
                                                        className={`aspect-square rounded-lg border text-[10px] ${isOff ? 'bg-rose-500 text-white border-rose-600' : 'bg-slate-50'}`}>
                                                        {d}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* 排班彈窗 */}
                    {popover && (
                        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-3xl w-full max-w-xs">
                                <div className="text-center font-black mb-4">{popover.staff.name} ({popover.date}日)</div>
                                <div className="grid grid-cols-2 gap-2">
                                    {['08-16', '10-17', '16-23', '17-23', '23-05'].map(t => (
                                        <button key={t} onClick={()=>{
                                            const newSched = {...schedules, [`${popover.staff.id}-${popover.date}`]: t};
                                            syncToCloud(staff, unavailabilities, newSched);
                                            setPopover(null);
                                        }} className="p-2 bg-slate-100 rounded-xl font-bold text-xs">{t}</button>
                                    ))}
                                </div>
                                <button onClick={()=>{
                                    const newSched = {...schedules}; delete newSched[`${popover.staff.id}-${popover.date}`];
                                    syncToCloud(staff, unavailabilities, newSched);
                                    setPopover(null);
                                }} className="w-full mt-4 text-rose-500 font-bold text-xs">清除</button>
                                <button onClick={()=>setPopover(null)} className="w-full mt-2 text-slate-400 font-bold text-xs">取消</button>
                            </div>
                        </div>
                    )}

                    {/* 密碼彈窗 */}
                    {showAuthModal && (
                        <div className="fixed inset-0 bg-slate-900/90 z-[200] flex items-center justify-center p-4">
                            <div className="bg-white p-8 rounded-[2rem] w-full max-w-xs text-center">
                                <div className="font-black mb-4">輸入管理密碼</div>
                                <input type="password" autoFocus className="w-full p-4 bg-slate-100 rounded-2xl text-center text-2xl font-black outline-none border-2 focus:border-indigo-500" value={authPassword} onChange={e=>setAuthPassword(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleAuthSubmit()} />
                                <div className="flex gap-2 mt-4">
                                    <button onClick={()=>setShowAuthModal(false)} className="flex-1 font-bold text-slate-400">取消</button>
                                    <button onClick={handleAuthSubmit} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">解鎖</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
