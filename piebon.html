<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Èõ≤Á´ØÊô∫ËÉΩÊéíÁè≠Á≥ªÁµ± PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.4); }
        .auth-modal-enter { animation: modalFadeIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .table-cell-date { min-width: 40px; width: 40px; }
        .table-cell-name { min-width: 80px; width: 80px; position: sticky; left: 0; z-index: 20; background: white; border-right: 2px solid #e2e8f0; }
        .row-height { height: 44px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // ÂàùÂßãÂåñ Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const PASSCODE = "0418";

        const LucideIcon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, className]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('unavail-view'); 
            const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
            const [authModal, setAuthModal] = useState({ show: false, callback: null, value: "" });
            const [currentDate, setCurrentDate] = useState(new Date());
            
            // Èõ≤Á´ØÂêåÊ≠•ÁãÄÊÖã
            const [isUnavailLocked, setIsUnavailLocked] = useState(false);
            const [hideUnavailMarker, setHideUnavailMarker] = useState(false);
            const [customRedDays, setCustomRedDays] = useState({});
            const [staff, setStaff] = useState([]);
            const [unavailData, setUnavailData] = useState({});
            const [scheduleData, setScheduleData] = useState({});
            
            const [popover, setPopover] = useState(null);

            // --- Èõ≤Á´ØË≥áÊñôÁõ£ËÅΩ ---
            useEffect(() => {
                const rootRef = db.ref('cloud_scheduler_v3');
                rootRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setStaff(data.staff || []);
                        setUnavailData(data.unavail || {});
                        setScheduleData(data.schedules || {});
                        setIsUnavailLocked(!!data.isUnavailLocked);
                        setCustomRedDays(data.customRedDays || {});
                    }
                    setLoading(false);
                });
                return () => rootRef.off();
            }, []);

            // --- Èõ≤Á´ØÂØ´ÂÖ•ÂáΩÊï∏ ---
            const cloudUpdate = (updates) => {
                db.ref('cloud_scheduler_v3').update(updates);
            };

            const requireAuth = (callback) => {
                if (isAdminAuthenticated) { callback(); } 
                else { setAuthModal({ show: true, callback, value: "" }); }
            };

            const handleAuthSubmit = () => {
                if (authModal.value === PASSCODE) {
                    setIsAdminAuthenticated(true);
                    setAuthModal({ ...authModal, show: false });
                    if (authModal.callback) authModal.callback();
                } else { alert("ÂØÜÁ¢ºÈåØË™§"); setAuthModal({ ...authModal, value: "" }); }
            };

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const datesArray = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const getDayColor = (d) => {
                const day = new Date(year, month, d).getDay();
                const key = `${year}-${month + 1}-${d}`;
                if (customRedDays[key]) return 'text-red-500';
                return (day === 0 || day === 6 || day === 5) ? 'text-red-500' : 'text-slate-800';
            };

            const checkConflict = (staffId, day, shiftStr) => {
                const uKey = `${staffId}-${year}-${month+1}-${day}`;
                const u = unavailData[uKey];
                if (!u) return false;
                if (u.full) return true;
                const match = shiftStr.match(/(\d+)-(\d+)/);
                if (!match) return false;
                const start = parseInt(match[1]), end = parseInt(match[2]);
                if (u.canUntil && end > parseInt(u.canUntil)) return true;
                if (u.noAfter && start < parseInt(u.noAfter)) return true;
                return false;
            };

            const getShiftBg = (shiftStr) => {
                const match = shiftStr.match(/(\d+)-/);
                if (!match) return "transparent";
                const start = parseInt(match[1]);
                if (start >= 8 && start < 16) return "rgba(250, 204, 21, 0.7)"; 
                if (start >= 16 && start < 23) return "rgba(244, 114, 182, 0.7)"; 
                return "rgba(59, 130, 246, 0.7)"; 
            };

            const stats = useMemo(() => {
                const res = {};
                staff.forEach(s => {
                    let hours = 0, days = 0;
                    datesArray.forEach(d => {
                        const shift = scheduleData[`${s.id}-${d}`];
                        const match = shift?.match(/(\d+)-(\d+)/);
                        if (match) {
                            let h = parseInt(match[2]) - parseInt(match[1]);
                            if (h <= 0) h += 24;
                            hours += h; days++;
                        }
                    });
                    res[s.id] = { hours, days };
                });
                return res;
            }, [scheduleData, staff, datesArray]);

            const exportAsImage = () => {
                const target = document.getElementById('export-area');
                html2canvas(target, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `ÊéíÁè≠Ë°®_${year}_${month+1}.png`;
                    link.href = canvas.toDataURL(); link.click();
                });
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-3">
                        <div className="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <span className="font-black text-slate-400">Èõ≤Á´ØË≥áÊñôÂêåÊ≠•‰∏≠...</span>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col pb-20">
                    <nav className="glass sticky top-0 z-50 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-black text-slate-800 tracking-tighter flex items-center gap-1">
                                <LucideIcon name="cloud" className="text-blue-600"/> Êô∫ËÉΩÈõ≤Á´ØÊéíÁè≠
                            </h1>
                            <div className="hidden md:flex bg-slate-100 p-1 rounded-xl gap-1">
                                <button onClick={() => setView('unavail-view')} className={`px-4 py-1.5 rounded-lg text-sm font-black transition ${view === 'unavail-view' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>Âì°Â∑•Áï´‰ºë</button>
                                <button onClick={() => requireAuth(() => setView('admin-schedule'))} className={`px-4 py-1.5 rounded-lg text-sm font-black transition ${view === 'admin-schedule' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>ÁÆ°ÁêÜÊéíÁè≠</button>
                                <button onClick={() => requireAuth(() => setView('staff-manage'))} className={`px-4 py-1.5 rounded-lg text-sm font-black transition ${view === 'staff-manage' ? 'bg-white shadow text-blue-600' : 'text-slate-400'}`}>‰∫∫Âì°ÁÆ°ÁêÜ</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1))} className="p-2 border rounded-lg hover:bg-slate-50"><LucideIcon name="chevron-left" size={16}/></button>
                            <span className="px-2 font-black text-sm">{year}/{month + 1}</span>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1))} className="p-2 border rounded-lg hover:bg-slate-50"><LucideIcon name="chevron-right" size={16}/></button>
                            {isAdminAuthenticated && <button onClick={()=>setIsAdminAuthenticated(false)} className="ml-2 text-red-500 p-2"><LucideIcon name="log-out" size={18}/></button>}
                        </div>
                    </nav>

                    <main className="p-4 flex-1">
                        {view === 'staff-manage' && (
                            <div className="max-w-4xl mx-auto space-y-4">
                                <button onClick={() => cloudUpdate({ staff: [...staff, { id: Date.now().toString(), name: 'Êñ∞‰∫∫Âì°', type: 'part-time', shifts: [], order: staff.length + 1 }] })} className="w-full bg-slate-800 text-white p-4 rounded-2xl font-black flex justify-center items-center gap-2 shadow-lg">
                                    <LucideIcon name="plus" size={18}/> Êñ∞Â¢û‰∫∫Âì°ÂêçÂñÆ
                                </button>
                                {staff.sort((a,b) => a.order - b.order).map(s => (
                                    <div key={s.id} className="bg-white p-3 rounded-2xl border flex items-center gap-4 shadow-sm">
                                        <input type="number" className="w-10 border rounded-lg p-1 text-center font-black text-blue-600" value={s.order} onChange={(e)=>cloudUpdate({ staff: staff.map(i=>i.id===s.id?{...i, order: parseInt(e.target.value)||0}:i) })}/>
                                        <input className="font-black border-b border-transparent focus:border-blue-500 outline-none w-24" value={s.name} onChange={(e)=>cloudUpdate({ staff: staff.map(i=>i.id===s.id?{...i, name:e.target.value}:i) })}/>
                                        <button onClick={()=>cloudUpdate({ staff: staff.filter(i=>i.id!==s.id) })} className="ml-auto text-red-300 hover:text-red-500 p-2"><LucideIcon name="trash-2" size={18}/></button>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'unavail-view' && (
                            <div className="space-y-6">
                                <div className="bg-white p-4 rounded-3xl shadow-sm border flex justify-between items-center">
                                    <span className="font-black text-slate-700">{isUnavailLocked ? 'üî¥ Áï´‰ºëÂäüËÉΩÂ∑≤ÈéñÂÆö' : 'üü¢ Âì°Â∑•ÈñãÊîæÁï´‰ºë‰∏≠'}</span>
                                    <button onClick={() => requireAuth(() => cloudUpdate({ isUnavailLocked: !isUnavailLocked }))} className="bg-slate-800 text-white px-5 py-2 rounded-2xl font-black text-sm">
                                        ÂàáÊèõÊ¨äÈôê
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {staff.sort((a,b)=>a.order-b.order).map(s => (
                                        <div key={s.id} className="bg-white rounded-[2rem] border overflow-hidden shadow-sm p-4">
                                            <div className="font-black text-lg mb-3 px-1">{s.name}</div>
                                            <div className="grid grid-cols-7 gap-1">
                                                {datesArray.map(d => {
                                                    const k = `${s.id}-${year}-${month+1}-${d}`;
                                                    const isOff = unavailData[k]?.full;
                                                    return (
                                                        <button key={d} disabled={isUnavailLocked}
                                                            onClick={() => setPopover({ type: 'unavail', staffId: s.id, day: d })}
                                                            className={`aspect-square rounded-xl flex items-center justify-center text-[10px] font-black border transition ${isOff ? 'bg-slate-600 text-white' : 'bg-slate-50 text-slate-400'}`}>
                                                            {d}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'admin-schedule' && (
                            <div className="bg-white rounded-3xl border shadow-xl overflow-hidden" id="export-area">
                                <div className="p-3 border-b flex justify-between items-center bg-slate-50/50">
                                    <div className="flex gap-2">
                                        <button onClick={()=>setHideUnavailMarker(!hideUnavailMarker)} className="p-2 bg-white border rounded-xl"><LucideIcon name={hideUnavailMarker ? "eye-off" : "eye"} size={18}/></button>
                                        <button onClick={exportAsImage} className="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-black">Â∞éÂá∫Áè≠Ë°®</button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto no-scrollbar max-w-sm">
                                        {staff.map(s => <span key={s.id} className="whitespace-nowrap bg-white border rounded px-2 py-1 text-[10px] font-black">{s.name}: {stats[s.id]?.hours}h</span>)}
                                    </div>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="min-w-full">
                                        <thead>
                                            <tr className="bg-slate-50">
                                                <th className="table-cell-name p-2 border-b text-[10px] font-black">‰∫∫Âì°</th>
                                                {datesArray.map(d => <th key={d} className={`table-cell-date p-1 border-b border-r text-center ${getDayColor(d)}`}>{d}</th>)}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {staff.sort((a,b)=>a.order-b.order).map(s => (
                                                <tr key={s.id} className="row-height">
                                                    <td className="table-cell-name p-0 text-center border-b font-black text-xs">{s.name}</td>
                                                    {datesArray.map(d => {
                                                        const sKey = `${s.id}-${d}`, uKey = `${s.id}-${year}-${month+1}-${d}`;
                                                        const shift = scheduleData[sKey], u = unavailData[uKey];
                                                        const hasConflict = shift && checkConflict(s.id, d, shift);
                                                        return (
                                                            <td key={d} onClick={()=>setPopover({type:'schedule', staffId: s.id, day: d})} className="table-cell-date border-r border-b relative row-height cursor-pointer">
                                                                {u && !hideUnavailMarker && <div className="absolute inset-0 z-0 bg-slate-800/20 flex items-center justify-center font-black text-[10px]">{u.full?'‰ºë':u.canUntil?'~'+u.canUntil:u.noAfter?u.noAfter+'~':''}</div>}
                                                                {shift && (
                                                                    <div className="absolute inset-0 z-10 flex flex-col items-center justify-center" style={{ backgroundColor: getShiftBg(shift) }}>
                                                                        {shift.split('-').map((t,i)=><span key={i} className="text-[11px] font-black leading-none">{t}</span>)}
                                                                        {hasConflict && <div className="absolute -top-1 -right-1 bg-red-600 text-white text-[8px] px-1 rounded animate-pulse">!</div>}
                                                                    </div>
                                                                )}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Popover ÊéßÂà∂Âô® */}
                    {popover && (
                        <div className="fixed inset-0 bg-slate-900/30 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={()=>setPopover(null)}>
                            <div className="bg-white rounded-[2rem] w-full max-w-[320px] shadow-2xl p-6 auth-modal-enter" onClick={e=>e.stopPropagation()}>
                                <h3 className="font-black mb-4">{popover.day}Êó• {popover.type==='unavail'?'Áï´‰ºë':'ÊéíÁè≠'}</h3>
                                <div className="grid grid-cols-2 gap-2">
                                    {popover.type === 'schedule' ? (
                                        <>
                                            {['08-16', '10-18', '12-20', '16-23', '17-23', '23-05'].map(t => (
                                                <button key={t} onClick={()=>{cloudUpdate({ schedules: {...scheduleData, [`${popover.staffId}-${popover.day}`]: t} }); setPopover(null)}} className="p-3 bg-slate-100 rounded-xl font-black text-xs">{t}</button>
                                            ))}
                                            <button onClick={()=>{const n={...scheduleData}; delete n[`${popover.staffId}-${popover.day}`]; cloudUpdate({schedules:n}); setPopover(null)}} className="col-span-2 p-3 text-red-500 font-black">Ê∏ÖÈô§Áè≠Ë°®</button>
                                        </>
                                    ) : (
                                        <>
                                            <button onClick={()=>{
                                                const k = `${popover.staffId}-${year}-${month+1}-${popover.day}`;
                                                cloudUpdate({ unavail: {...unavailData, [k]: {full: !unavailData[k]?.full}} });
                                            }} className="col-span-2 p-4 bg-slate-800 text-white rounded-xl font-black">ÂÖ®Â§©‰ºëÂÅá</button>
                                            <input type="number" placeholder="ÂπæÈªûÂâçÂèØÂà∞" className="p-3 border rounded-xl" onBlur={(e)=>cloudUpdate({unavail: {...unavailData, [`${popover.staffId}-${year}-${month+1}-${popover.day}`]: {canUntil: e.target.value}}})}/>
                                            <input type="number" placeholder="ÂπæÈªûÂæåÂèØÂà∞" className="p-3 border rounded-xl" onBlur={(e)=>cloudUpdate({unavail: {...unavailData, [`${popover.staffId}-${year}-${month+1}-${popover.day}`]: {noAfter: e.target.value}}})}/>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Auth Modal */}
                    {authModal.show && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[200] flex items-center justify-center p-6">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl auth-modal-enter text-center">
                                <LucideIcon name="shield-check" size={48} className="text-blue-600 mx-auto mb-4"/>
                                <h3 className="text-xl font-black mb-6 text-slate-800">ÁÆ°ÁêÜÊéàÊ¨ä</h3>
                                <input type="password" autoFocus className="w-full bg-slate-100 rounded-2xl p-4 text-center text-3xl font-black mb-6 outline-none border-2 focus:border-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={authModal.value} onChange={(e)=>setAuthModal({...authModal, value: e.target.value})} onKeyDown={(e)=>e.key==='Enter' && handleAuthSubmit()} />
                                <div className="flex gap-4">
                                    <button onClick={()=>setAuthModal({show:false, callback:null, value:""})} className="flex-1 font-black text-slate-400">ÂèñÊ∂à</button>
                                    <button onClick={handleAuthSubmit} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black">ÁôªÂÖ•</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
