<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業雲端排班系統 PRO - 完整功能版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .schedule-cell { height: 44px; min-width: 50px; position: relative; }
        .table-sticky-col { position: sticky; left: 0; z-index: 20; background: white; border-right: 2px solid #e2e8f0; }
        .conflict-alert { border: 2px solid #ef4444; background-color: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const PASSCODE = "0418";

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name, className]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const App = () => {
            const [view, setView] = useState('user-unavail');
            const [isAdmin, setIsAdmin] = useState(false);
            const [showAuth, setShowAuth] = useState(false);
            const [authInput, setAuthInput] = useState("");
            const [loading, setLoading] = useState(true);
            const [currentDate, setCurrentDate] = useState(new Date());

            // 雲端同步狀態
            const [staff, setStaff] = useState([]);
            const [unavail, setUnavail] = useState({});
            const [schedules, setSchedules] = useState({});
            const [isLocked, setIsLocked] = useState(false);
            const [customRedDays, setCustomRedDays] = useState({});
            
            const [popover, setPopover] = useState(null);

            useEffect(() => {
                const ref = db.ref('v3_smart_shift_pro');
                ref.on('value', (snap) => {
                    const d = snap.val() || {};
                    setStaff(d.staff || []);
                    setUnavail(d.unavail || {});
                    setSchedules(d.schedules || {});
                    setIsLocked(!!d.isLocked);
                    setCustomRedDays(d.customRedDays || {});
                    setLoading(false);
                });
                return () => ref.off();
            }, []);

            const sync = (data) => db.ref('v3_smart_shift_pro').update(data);

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dates = Array.from({ length: daysInMonth }, (_, i) => i + 1);

            const isRed = (d) => {
                const day = new Date(year, month, d).getDay();
                const key = `${year}-${month + 1}-${d}`;
                return customRedDays[key] || day === 0 || day === 6;
            };

            const getShiftColor = (time) => {
                const start = parseInt(time.split('-')[0]);
                if (start < 16) return "bg-amber-400/80";
                if (start < 23) return "bg-pink-400/80";
                return "bg-indigo-400/80";
            };

            const stats = useMemo(() => {
                const res = {};
                staff.forEach(s => {
                    let h = 0, d = 0;
                    dates.forEach(day => {
                        const shift = schedules[`${s.id}-${day}`];
                        if (shift) {
                            const [sT, eT] = shift.split('-').map(Number);
                            let diff = eT - sT;
                            h += diff <= 0 ? diff + 24 : diff;
                            d++;
                        }
                    });
                    res[s.id] = { h, d };
                });
                return res;
            }, [staff, schedules, dates]);

            if (loading) return <div className="h-screen flex items-center justify-center font-black text-slate-400 animate-pulse">同步雲端中...</div>;

            return (
                <div className="max-w-full min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-50 shadow-sm">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl font-black text-slate-800 flex items-center gap-1">
                                <Icon name="calendar-check" className="text-indigo-600" /> 智慧雲端 PRO
                            </h1>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                <button onClick={() => setView('user-unavail')} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition ${view === 'user-unavail' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>畫休</button>
                                <button onClick={() => isAdmin ? setView('admin-schedule') : setShowAuth(true)} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition ${view === 'admin-schedule' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>排班</button>
                                <button onClick={() => isAdmin ? setView('staff-manage') : setShowAuth(true)} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition ${view === 'staff-manage' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>人員</button>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setCurrentDate(new Date(year, month - 1))} className="p-2 border rounded-lg"><Icon name="chevron-left" /></button>
                            <span className="font-black text-sm">{year}/{month + 1}</span>
                            <button onClick={() => setCurrentDate(new Date(year, month + 1))} className="p-2 border rounded-lg"><Icon name="chevron-right" /></button>
                        </div>
                    </header>

                    <main className="p-4 flex-1">
                        {/* 統計區域 (排班模式才顯示) */}
                        {view === 'admin-schedule' && (
                            <div className="mb-4 flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                {staff.map(s => (
                                    <div key={s.id} className="bg-white border rounded-2xl p-3 min-w-[100px] shadow-sm">
                                        <div className="text-[10px] font-black text-slate-400">{s.name}</div>
                                        <div className="flex justify-between items-end">
                                            <span className="text-lg font-black text-indigo-600">{stats[s.id]?.h}h</span>
                                            <span className="text-[10px] font-bold text-slate-300">{stats[s.id]?.d}d</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 畫休模式介面 */}
                        {view === 'user-unavail' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {staff.sort((a,b)=>a.order-b.order).map(s => (
                                    <div key={s.id} className="bg-white rounded-3xl border shadow-sm p-4">
                                        <div className="font-black text-lg mb-3 flex justify-between items-center">
                                            {s.name}
                                            <span className="text-[10px] bg-indigo-50 text-indigo-500 px-2 py-1 rounded-lg uppercase">{s.type === 'full-time' ? '正職' : '兼職'}</span>
                                        </div>
                                        <div className="calendar-grid">
                                            {dates.map(d => {
                                                const k = `${s.id}-${year}-${month+1}-${d}`;
                                                const u = unavail[k];
                                                return (
                                                    <button key={d} disabled={isLocked}
                                                        onClick={() => setPopover({ type: 'unavail', sid: s.id, d })}
                                                        className={`aspect-square rounded-xl flex items-center justify-center text-xs font-black border transition 
                                                        ${u?.full ? 'bg-slate-700 border-slate-700 text-white' : (u?.canUntil || u?.noAfter ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-slate-50 text-slate-400')}
                                                        ${isRed(d) ? 'ring-1 ring-red-200' : ''}`}>
                                                        {d}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 排班模式介面 */}
                        {view === 'admin-schedule' && (
                            <div className="bg-white rounded-3xl border shadow-xl overflow-hidden">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50/50">
                                    <button onClick={() => sync({ isLocked: !isLocked })} className={`px-4 py-2 rounded-xl font-black text-xs ${isLocked ? 'bg-red-500 text-white' : 'bg-emerald-500 text-white'}`}>
                                        {isLocked ? '畫休已鎖定' : '畫休開放中'}
                                    </button>
                                    <button onClick={() => {
                                        html2canvas(document.getElementById('export-area')).then(canvas => {
                                            const a = document.createElement('a'); a.download='班表.png'; a.href=canvas.toDataURL(); a.click();
                                        });
                                    }} className="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-black">導出班表圖片</button>
                                </div>
                                <div className="overflow-x-auto" id="export-area">
                                    <table className="w-full border-collapse">
                                        <thead>
                                            <tr className="bg-slate-100">
                                                <th className="p-3 border-b border-r table-sticky-col text-xs font-black">員工</th>
                                                {dates.map(d => (
                                                    <th key={d} onClick={() => {
                                                        const k = `${year}-${month+1}-${d}`;
                                                        sync({ customRedDays: {...customRedDays, [k]: !customRedDays[k]} });
                                                    }} className={`p-2 border-b border-r text-center cursor-pointer ${isRed(d) ? 'text-red-500 bg-red-50' : 'text-slate-400'}`}>
                                                        <div className="text-xs font-black">{d}</div>
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {staff.sort((a,b)=>a.order-b.order).map(s => (
                                                <tr key={s.id} className="row-height">
                                                    <td className="p-2 border-b border-r text-center font-black text-xs table-sticky-col">{s.name}</td>
                                                    {dates.map(d => {
                                                        const sk = `${s.id}-${d}`, uk = `${s.id}-${year}-${month+1}-${d}`;
                                                        const shift = schedules[sk], u = unavail[uk];
                                                        // 衝突邏輯
                                                        const isConflict = shift && (u?.full || (u?.canUntil && parseInt(shift.split('-')[1]) > u.canUntil) || (u?.noAfter && parseInt(shift.split('-')[0]) < u.noAfter));
                                                        
                                                        return (
                                                            <td key={d} onClick={() => setPopover({ type: 'schedule', sid: s.id, d })}
                                                                className={`border-r border-b schedule-cell cursor-pointer hover:bg-slate-50 transition`}>
                                                                {u && <div className="absolute inset-0 bg-slate-200/50 flex items-center justify-center font-black text-[10px] text-slate-400">{u.full?'休':u.canUntil?'~'+u.canUntil:u.noAfter?u.noAfter+'~':''}</div>}
                                                                {shift && (
                                                                    <div className={`absolute inset-0 flex flex-col items-center justify-center z-10 ${getShiftColor(shift)} ${isConflict ? 'conflict-alert' : ''}`}>
                                                                        {shift.split('-').map((t,i) => <span key={i} className="text-[11px] font-black leading-none">{t}</span>)}
                                                                        {isConflict && <div className="absolute top-0 right-0 bg-red-600 text-white text-[8px] px-1 animate-bounce">!</div>}
                                                                    </div>
                                                                )}
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* 彈窗：畫休或排班設定 */}
                    {popover && (
                        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] flex items-center justify-center p-4" onClick={() => setPopover(null)}>
                            <div className="bg-white rounded-[2rem] w-full max-w-[320px] p-6 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="font-black text-lg mb-4 text-center">{popover.d}日 {popover.type === 'unavail' ? '畫休設定' : '排班設定'}</h3>
                                {popover.type === 'unavail' ? (
                                    <div className="space-y-4">
                                        <button onClick={() => {
                                            const k = `${popover.sid}-${year}-${month+1}-${popover.d}`;
                                            sync({ unavail: {...unavail, [k]: { full: !unavail[k]?.full }} });
                                            setPopover(null);
                                        }} className="w-full py-4 bg-slate-800 text-white rounded-2xl font-black">全天休假</button>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input type="number" placeholder="幾點前可到" className="p-3 border rounded-xl text-sm" onBlur={(e) => sync({ unavail: {...unavail, [`${popover.sid}-${year}-${month+1}-${popover.d}`]: { canUntil: e.target.value }} })} />
                                            <input type="number" placeholder="幾點後可到" className="p-3 border rounded-xl text-sm" onBlur={(e) => sync({ unavail: {...unavail, [`${popover.sid}-${year}-${month+1}-${popover.d}`]: { noAfter: e.target.value }} })} />
                                        </div>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-2">
                                        {['08-16', '10-18', '12-20', '16-23', '17-23', '23-05'].map(t => (
                                            <button key={t} onClick={() =>
