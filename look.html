<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>盤點叫貨系統 - 多商家獨立版</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body { font-family: 'Noto Sans TC', sans-serif; background:#f8fafc; }
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
</style>
</head>

<body>
<div id="root" class="p-4 max-w-xl mx-auto"></div>

<script>
// Firebase 初始化
firebase.initializeApp({
  apiKey: "AIzaSyCu_W2qzTZTMm0cOh1Gc7ys8uDKJEkzD7M",
  authDomain: "all-sun-e7472.firebaseapp.com",
  databaseURL: "https://all-sun-e7472-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "all-sun-e7472"
});
const db = firebase.database();

/* ===== 狀態 ===== */
let merchants = [];
let currentMerchant = '';
let items = [];
let stockCounts = {};
let dayType = 'weekday';
let managementMode = false;

// 網址參數
const params = new URLSearchParams(window.location.search);
const merchantFromUrl = params.get('merchant');
const pageId = params.get('page') || Date.now(); // 唯一 pageId
if(merchantFromUrl) currentMerchant = merchantFromUrl;

const root = document.getElementById('root');

/* ===== 獨立商家與資料路徑 ===== */
function getDbPath() {
  return 'inventory_tool/' + pageId + '/' + currentMerchant;
}

function loadMerchants() {
  db.ref('inventory_tool/' + pageId + '/merchants').once('value').then(snap=>{
    const val = snap.val() || {};
    merchants = Object.keys(val);
    if(merchants.length === 0) {
      const init = currentMerchant || '商家A';
      merchants = [init];
      currentMerchant = init;
      db.ref('inventory_tool/' + pageId + '/merchants/' + init).set(true);
    } else {
      if(!currentMerchant) currentMerchant = merchants[0];
    }
    loadData();
  });
}

/* ===== 資料 ===== */
function loadData() {
  db.ref(getDbPath()).once('value').then(snap=>{
    const val = snap.val() || {};
    items = val.items || [];
    stockCounts = val.stockCounts || {};
    render();
  });
}

function syncCloud() {
  db.ref(getDbPath()).set({ items, stockCounts });
}

/* ===== UI 渲染 ===== */
function render() {
  root.innerHTML = '';

  const container = document.createElement('div');

  // 商家選擇 + 管理
  const merchantDiv = document.createElement('div');
  merchantDiv.className='mb-4 flex gap-2';
  merchantDiv.innerHTML = `
    <select class="flex-1 border p-2 rounded" onchange="changeMerchant(this.value)">
      ${merchants.map(m=>`<option ${m===currentMerchant?'selected':''}>${m}</option>`).join('')}
    </select>
    <button class="px-3 bg-slate-600 text-white rounded" onclick="manageMerchant()">管理商家</button>
  `;
  container.appendChild(merchantDiv);

  // 標題 + 管理模式 + 歸零按鈕
  const header = document.createElement('div');
  header.className='flex justify-between mb-3 items-center';
  header.innerHTML = `
    <h1 class="font-bold text-lg">盤點叫貨系統</h1>
    <div class="flex gap-2">
      <button class="px-3 py-1 bg-blue-600 text-white rounded" onclick="toggleManage()">
        ${managementMode?'完成設定':'管理品項'}
      </button>
      <button class="px-3 py-1 bg-red-600 text-white rounded" onclick="resetStocks()">
        一鍵歸零
      </button>
    </div>
  `;
  container.appendChild(header);

  // 平日/假日切換
  const dayDiv = document.createElement('div');
  dayDiv.className='flex gap-2 mb-4';
  dayDiv.innerHTML = `
    <button class="flex-1 py-1 ${dayType==='weekday'?'bg-blue-600 text-white':'bg-slate-200'}" onclick="setDay('weekday')">平日</button>
    <button class="flex-1 py-1 ${dayType==='weekend'?'bg-orange-500 text-white':'bg-slate-200'}" onclick="setDay('weekend')">假日</button>
  `;
  container.appendChild(dayDiv);

  // 品項列表
  items.forEach(item=>{
    const div = document.createElement('div');
    div.className='bg-white p-2 mb-2 rounded shadow';

    if(managementMode){
      div.innerHTML = `
        <input value="${item.name}" onchange="editItem(${item.id},'name',this.value)" class="w-full border-b mb-1" placeholder="品項名稱">
        <div class="flex gap-2 mb-1">
          <input type="number" value="${item.weekdayMin||0}" onchange="editItem(${item.id},'weekdayMin',this.value)" class="w-1/2 border p-1" placeholder="平日最低">
          <input type="number" value="${item.weekendMin||0}" onchange="editItem(${item.id},'weekendMin',this.value)" class="w-1/2 border p-1" placeholder="假日最低">
        </div>
        <input value="${item.unit||''}" onchange="editItem(${item.id},'unit',this.value)" class="w-full border p-1 mb-1" placeholder="單位">
        <input value="${(item.relatedItems||[]).join(',')}" onchange="editItem(${item.id},'relatedItems',this.value)" class="w-full border p-1" placeholder="關聯食材（逗號分隔）">
      `;
    } else {
      div.innerHTML = `
        <div class="flex justify-between items-center">
          <span>${item.name}</span>
          <div class="flex items-center gap-1">
            <button onclick="adjustStock(${item.id},-0.5)" class="w-8 h-8 bg-slate-200 rounded">−</button>
            <input type="number" step="0.5" value="${stockCounts[item.id]||0}" 
                   class="w-16 text-center border rounded" 
                   onchange="manualInput(${item.id},this.value)">
            <button onclick="adjustStock(${item.id},0.5)" class="w-8 h-8 bg-slate-200 rounded">＋</button>
            <span class="ml-1">${item.unit||''}</span>
          </div>
        </div>
      `;
    }

    container.appendChild(div);
  });

  // 新增品項
  if(managementMode){
    const addBtn = document.createElement('button');
    addBtn.className='w-full border-dashed border-2 p-2 mt-2';
    addBtn.innerText = '新增品項';
    addBtn.onclick = addItem;
    container.appendChild(addBtn);
  }

  // 補貨清單
  const orderDiv = document.createElement('div');
  orderDiv.className='mt-4 bg-white p-3 rounded shadow';
  orderDiv.innerHTML = `<h2 class="font-bold mb-2">補貨清單</h2>`;
  const list = [];
  items.forEach(item=>{
    const need = calculateNeed(item, stockCounts[item.id]);
    if(need>0){
      if(item.relatedItems && item.relatedItems.length>0) list.push(...item.relatedItems);
      else list.push(`${item.name} +${need} ${item.unit||''}`);
    }
  });
  if(list.length===0) orderDiv.innerHTML += `<p class="text-sm text-slate-400">目前無需補貨</p>`;
  else{
    orderDiv.innerHTML += `<p class="text-sm mb-2">${list.join('， ')}</p>`;
    const copyBtn = document.createElement('button');
    copyBtn.innerText='一鍵複製補貨清單';
    copyBtn.className='w-full py-2 bg-blue-600 text-white rounded';
    copyBtn.onclick=()=>{ navigator.clipboard.writeText(list.join('\n')); alert('已複製到剪貼簿'); };
    orderDiv.appendChild(copyBtn);
  }

  root.appendChild(container);
  root.appendChild(orderDiv);
}

/* ===== 行為 ===== */
function toggleManage(){ managementMode=!managementMode; render(); }
function setDay(d){ dayType=d; render(); }
function changeMerchant(m){ currentMerchant=m; loadData(); }
function manageMerchant(){
  const cmd = prompt('新增:商家C 或 刪除:商家B');
  if(!cmd) return;
  const [a,n] = cmd.split(':');
  if(a==='新增' && n) db.ref('inventory_tool/'+pageId+'/merchants/'+n).set(true);
  if(a==='刪除' && n) db.ref('inventory_tool/'+pageId+'/merchants/'+n).remove();
  loadMerchants();
}
function addItem(){
  items.push({id:Date.now(),name:'',weekdayMin:0,weekendMin:0,unit:'',relatedItems:[]});
  syncCloud(); render();
}
function editItem(id,key,val){
  const i=items.find(x=>x.id===id);
  if(!i) return;
  if(key==='relatedItems') i[key]=val.split(',').map(s=>s.trim()).filter(Boolean);
  else i[key] = isNaN(val)?val:+val;
  syncCloud();
}
function adjustStock(id,delta){
  stockCounts[id]=(stockCounts[id]||0)+delta;
  if(stockCounts[id]<0) stockCounts[id]=0;
  syncCloud(); render();
}
function manualInput(id,val){
  stockCounts[id] = parseFloat(val)||0;
  syncCloud(); render();
}
function resetStocks(){
  Object.keys(stockCounts).forEach(k=>stockCounts[k]=0);
  syncCloud(); render();
}
function calculateNeed(item,stock){
  const current = parseFloat(stock)||0;
  const min = dayType==='weekday'?item.weekdayMin||0:item.weekendMin||0;
  return Math.max(0,min-current);
}

/* 啟動 */
loadMerchants();
</script>
</body>
</html>
