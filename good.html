<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股市交易紀錄與損益看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 100px; transition: all 0.2s; border-right: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7; }
        .calendar-day:hover { background-color: #f9fafb; cursor: pointer; }
        .custom-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .stock-chip { cursor: pointer; transition: all 0.2s; }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">
    <div class="max-w-6xl mx-auto">
        <!-- 看板區 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                <p class="text-xs text-gray-500 font-bold mb-1">累積總損益</p>
                <h2 id="total-profit" class="text-3xl font-bold text-gray-800">$0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border-l-4 border-purple-500 relative">
                <p class="text-xs text-gray-500 font-bold mb-2">目前持股</p>
                <div id="current-holdings-list" class="flex flex-wrap gap-2 text-sm">
                    <span class="text-gray-400 italic">無數據</span>
                </div>
            </div>
        </div>

        <!-- 月份切換 -->
        <div class="bg-white rounded-t-2xl p-4 flex justify-between items-center border-b">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <h3 id="current-month-display" class="font-bold text-gray-700">載入中...</h3>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <!-- 行事曆主體 -->
        <div class="bg-white rounded-b-2xl custom-shadow overflow-hidden mb-6">
            <div class="calendar-grid bg-gray-50 border-b">
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">日</div>
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">一</div>
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">二</div>
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">三</div>
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">四</div>
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">五</div>
                <div class="py-2 text-center text-[10px] font-bold text-gray-400">六</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </div>

        <!-- 狀態與資訊 -->
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100">
            <div class="flex justify-between items-center">
                <h3 class="font-bold text-gray-700">交易紀錄</h3>
                <div id="cloud-status" class="text-[10px] flex items-center gap-1 px-2 py-1 rounded bg-gray-100 text-gray-500">
                    <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                    等待雲端配置中...
                </div>
            </div>
            <div id="stock-list-container" class="mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- 交易 Modal -->
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h4 id="modal-title" class="font-bold">記錄交易</h4>
                <button onclick="closeModal()" class="text-gray-400 text-xl">&times;</button>
            </div>
            <form id="trade-form" class="space-y-4">
                <input type="hidden" id="selected-date">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">股名</label>
                    <input type="text" id="stock-name" required class="w-full bg-gray-50 border-none rounded-lg p-3 mt-1 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">類型</label>
                        <select id="trade-type" class="w-full bg-gray-50 border-none rounded-lg p-3 mt-1 text-sm">
                            <option value="buy">買進</option>
                            <option value="sell">賣出</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">單價</label>
                        <input type="number" step="0.01" id="trade-price" required class="w-full bg-gray-50 border-none rounded-lg p-3 mt-1 text-sm">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">股數</label>
                    <input type="number" id="trade-amount" required class="w-full bg-gray-50 border-none rounded-lg p-3 mt-1 text-sm">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700 transition">確認儲存</button>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-xs font-medium hidden z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db = null;
        let transactions = JSON.parse(localStorage.getItem('local_stock_trades') || '[]');
        let currentMonth = new Date();

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2000);
        };

        // 背景監測配置注入
        const tryConnectCloud = async () => {
            const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            if (!configStr) return false;

            try {
                const config = JSON.parse(configStr);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(config);
                db = getFirestore(app);
                const auth = getAuth(app);
                
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const statusEl = document.getElementById('cloud-status');
                        statusEl.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> 雲端已同步 (${user.uid.substring(0,6)})`;
                        statusEl.classList.replace('text-gray-500', 'text-green-600');
                        
                        // 同步本地數據到雲端（如果有）
                        if (transactions.length > 0) {
                            transactions.forEach(async (t) => {
                                if (!t.synced) {
                                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `sync_${user.uid.substring(0,8)}`), {...t, synced: true});
                                }
                            });
                        }
                    }
                });
                return true;
            } catch (e) {
                console.warn("Cloud connection background attempt failed", e);
                return false;
            }
        };

        const render = () => {
            renderCalendar();
            renderList();
            updateStats();
            localStorage.setItem('local_stock_trades', JSON.stringify(transactions));
        };

        const updateStats = () => {
            let profit = 0;
            let holds = {};
            transactions.forEach(t => {
                const raw = t.price * t.amount;
                const fee = (t.type === 'buy') ? Math.max(20, Math.floor(raw * 0.001425)) : (Math.max(20, Math.floor(raw * 0.001425)) + Math.floor(raw * 0.003));
                profit += (t.type === 'buy' ? -(raw + fee) : (raw - fee));
                holds[t.name] = (holds[t.name] || 0) + (t.type === 'buy' ? t.amount : -t.amount);
            });
            document.getElementById('total-profit').innerText = `$${Math.round(profit).toLocaleString()}`;
            const hList = Object.keys(holds).filter(k => holds[k] > 0);
            document.getElementById('current-holdings-list').innerHTML = hList.length ? hList.map(k => `<span class="bg-purple-50 text-purple-600 px-2 py-1 rounded-md border border-purple-100">${k} (${holds[k]})</span>`).join('') : '<span class="text-gray-400 italic">無持股</span>';
        };

        const renderCalendar = () => {
            const body = document.getElementById('calendar-body');
            const display = document.getElementById('current-month-display');
            body.innerHTML = '';
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            display.innerText = `${y}年 ${m + 1}月`;
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < first; i++) body.innerHTML += '<div class="calendar-day bg-gray-50/30"></div>';
            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const div = document.createElement('div');
                div.className = 'calendar-day p-2 flex flex-col hover:bg-blue-50';
                div.onclick = () => {
                    document.getElementById('trade-form').reset();
                    document.getElementById('selected-date').value = dateStr;
                    document.getElementById('modal-title').innerText = `${dateStr} 記錄`;
                    document.getElementById('modal').classList.remove('hidden');
                };
                div.innerHTML = `<span class="text-[10px] font-bold text-gray-300">${d}</span>`;
                const dayTrades = transactions.filter(t => t.date === dateStr);
                if (dayTrades.length) {
                    let flow = 0;
                    dayTrades.forEach(t => {
                        const r = t.price * t.amount;
                        const f = (t.type === 'buy') ? Math.max(20, Math.floor(r * 0.001425)) : (Math.max(20, Math.floor(r * 0.001425)) + Math.floor(r * 0.003));
                        flow += (t.type === 'buy' ? -(r+f) : (r-f));
                    });
                    div.innerHTML += `<div class="mt-auto text-[9px] font-black text-center py-0.5 rounded ${flow>=0?'bg-red-50 text-red-500':'bg-green-50 text-green-600'}">${flow>=0?'+':''}${Math.round(flow)}</div>`;
                }
                body.appendChild(div);
            }
        };

        const renderList = () => {
            const container = document.getElementById('stock-list-container');
            if (transactions.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">尚無交易紀錄</p>'; return; }
            const sorted = [...transactions].sort((a,b) => b.ts - a.ts).slice(0, 10);
            container.innerHTML = sorted.map(t => `
                <div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded-lg">
                    <div>
                        <span class="font-bold ${t.type==='buy'?'text-blue-600':'text-orange-600'}">${t.type==='buy'?'買入':'賣出'}</span>
                        <span class="ml-2 font-bold text-gray-700">${t.name}</span>
                    </div>
                    <div class="text-gray-400">${t.date} · $${t.price} &times; ${t.amount}</div>
                </div>
            `).join('');
        };

        document.getElementById('trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const trade = {
                date: document.getElementById('selected-date').value,
                name: document.getElementById('stock-name').value,
                type: document.getElementById('trade-type').value,
                price: parseFloat(document.getElementById('trade-price').value),
                amount: parseInt(document.getElementById('trade-amount').value),
                ts: Date.now(),
                synced: false
            };
            transactions.push(trade);
            render();
            closeModal();
            showToast("交易已儲存至本地");
            
            // 嘗試推送到雲端
            if (db) {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `sync_local`), {...trade, synced: true});
                } catch (e) {}
            }
        });

        window.changeMonth = (v) => { currentMonth.setMonth(currentMonth.getMonth() + v); render(); };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');

        // 啟動流程
        render();
        // 嘗試背景連線
        tryConnectCloud();
        // 5秒後再試一次（處理注入延遲）
        setTimeout(tryConnectCloud, 5000);
    </script>
</body>
</html>
