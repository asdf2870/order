<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股市交易紀錄與損益看板 (強化明細版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 110px; transition: all 0.2s; border-right: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7; }
        .calendar-day:hover { background-color: #f9fafb; cursor: pointer; }
        .custom-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
        .stock-tag { cursor: pointer; transition: all 0.2s; }
        .stock-tag:hover { background-color: #dbeafe; color: #1e40af; border-color: #3b82f6; }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">
    <!-- 載入層 -->
    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-600 font-medium italic">正在建立加密連線...</p>
        <p id="error-msg" class="mt-2 text-xs text-red-400 hidden text-center px-4">雲端連線失敗，目前為離線預覽模式</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- 頂部數據看板 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-blue-500 flex flex-col justify-center">
                <p class="text-sm text-gray-500 font-medium">累計已實現損益 (含股息)</p>
                <h2 id="total-profit" class="text-3xl font-bold mt-1 text-gray-800">$0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-green-500 flex flex-col justify-center">
                <p class="text-sm text-gray-500 font-medium">目前庫存成本 (未結算)</p>
                <h2 id="total-cost" class="text-3xl font-bold mt-1 text-gray-800">$0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-purple-500 relative">
                <p class="text-sm text-gray-500 font-medium mb-2">目前持有股票 (股名+股數)</p>
                <div id="current-holdings-list" class="flex flex-wrap gap-2">
                    <span class="text-gray-400 text-sm italic">尚無持股</span>
                </div>
                <button onclick="openSyncModal()" class="absolute top-4 right-4 text-blue-500 hover:text-blue-700 transition" title="切換同步帳號">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.803a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.1-1.1" /></svg>
                </button>
            </div>
        </div>

        <!-- 月份切換 -->
        <div class="bg-white rounded-t-2xl p-4 flex justify-between items-center border-b">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <div class="text-center">
                <h3 id="current-month-display" class="text-xl font-bold text-gray-700">正在載入...</h3>
                <p id="month-summary" class="text-[10px] text-gray-400 font-medium"></p>
            </div>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <div class="bg-white rounded-b-2xl custom-shadow overflow-hidden mb-8">
            <div class="calendar-grid bg-gray-50 border-b">
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">日</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">一</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">二</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">三</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">四</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">五</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">六</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </div>

        <div class="bg-white rounded-2xl custom-shadow p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">歷史交易明細表 (含個股統計)</h3>
                <div class="text-[10px] text-gray-400">同步碼: <span id="sync-code-display" class="font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-600 italic">尚未設定</span></div>
            </div>
            <div id="stock-list-container" class="space-y-4">
                <p class="text-gray-400 text-center py-4">目前尚無交易數據</p>
            </div>
        </div>
    </div>

    <!-- Modal 同步設定 -->
    <div id="sync-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-white rounded-2xl max-w-sm w-full p-6 shadow-2xl">
            <h4 class="text-lg font-bold text-gray-800 mb-2">同步管理</h4>
            <div class="space-y-4">
                <input type="text" id="sync-input" class="block w-full rounded-xl border-gray-200 bg-gray-50 px-4 py-3 text-center text-xl font-mono font-bold tracking-widest outline-none" placeholder="輸入同步碼">
                <button onclick="saveSyncCode()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">確認同步</button>
                <button onclick="closeSyncModal()" class="w-full text-gray-400 text-sm py-2">取消</button>
            </div>
        </div>
    </div>

    <!-- Modal 交易紀錄 -->
    <div id="modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h4 id="modal-title" class="text-lg font-bold text-gray-800">交易紀錄</h4>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">&times;</button>
            </div>
            <form id="trade-form" class="space-y-4">
                <input type="hidden" id="selected-date">
                <input type="hidden" id="edit-transaction-id">
                
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 ml-1">項目/股票名稱</label>
                    <input type="text" id="stock-name" required class="block w-full rounded-xl border-gray-200 bg-gray-50 px-4 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="如：台積電 或 銀行利息">
                    <div id="quick-stock-tags" class="flex flex-wrap gap-2 pt-1"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 ml-1">交易類型</label>
                        <select id="trade-type" class="block w-full rounded-xl border-gray-200 bg-gray-50 px-4 py-3" onchange="calculateSubtotal()">
                            <option value="buy">買進 (+)</option>
                            <option value="sell">賣出 (-)</option>
                            <option value="dividend">股息/利息 (+)</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-gray-500 ml-1">成交單價/金額</label>
                        <input type="number" step="0.01" id="trade-price" required class="block w-full rounded-xl border-gray-200 bg-gray-50 px-4 py-3" placeholder="單價" oninput="calculateSubtotal()">
                    </div>
                </div>
                
                <div class="space-y-2" id="amount-container">
                    <label class="text-xs font-bold text-gray-500 ml-1">成交股數 (股息請填 1)</label>
                    <input type="number" id="trade-amount" required class="block w-full rounded-xl border-gray-200 bg-gray-50 px-4 py-3" placeholder="股數" oninput="calculateSubtotal()">
                </div>
                
                <div class="bg-gray-50 rounded-xl p-4 space-y-2 border border-dashed border-gray-300">
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>成交額: <span id="raw-subtotal">$0</span></span>
                        <span>手續費: <span id="fee-display">$0</span></span>
                    </div>
                    <div class="flex justify-between items-center border-t border-gray-200 pt-2">
                        <span class="text-gray-500 text-sm font-medium">預計結算/入帳額</span>
                        <span id="subtotal-display" class="text-xl font-bold text-gray-800">$0</span>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition">儲存紀錄</button>
                <button type="button" id="delete-btn" onclick="deleteTransaction()" class="hidden w-full bg-red-50 text-red-500 font-bold py-3 rounded-xl">刪除紀錄</button>
            </form>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[100]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBzWK76cZTIKEoJGoc9bqi0M4sGLIMsUaE",
            authDomain: "good-e9e4e.firebaseapp.com",
            projectId: "good-e9e4e",
            storageBucket: "good-e9e4e.firebasestorage.app",
            messagingSenderId: "878748843198",
            appId: "1:878748843198:web:6183a33453463ef8e2b2ef"
        };

        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'stock-tracker-v3';
        let transactions = [];
        let currentMonth = new Date();
        let currentSyncId = localStorage.getItem('user_sync_code');
        let unsubscribe = null;

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        };

        const init = async () => {
            const config = (typeof __firebase_config !== 'undefined' && __firebase_config) ? JSON.parse(__firebase_config) : defaultFirebaseConfig;
            const app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (u) => {
                if (u) {
                    if (!currentSyncId) { currentSyncId = u.uid.substring(0, 8); localStorage.setItem('user_sync_code', currentSyncId); }
                    document.getElementById('sync-code-display').innerText = currentSyncId;
                    startSync();
                    document.getElementById('loader').classList.add('hidden');
                }
            });
        };

        function startSync() {
            if (unsubscribe) unsubscribe();
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', `sync_${currentSyncId}`);
            unsubscribe = onSnapshot(colRef, (snap) => {
                transactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.date.localeCompare(b.date) || (a.ts || 0) - (b.ts || 0));
                updateUI();
            });
        }

        function calculateTotalWithFees(price, amount, type) {
            const rawSubtotal = price * amount;
            if (type === 'dividend') return { raw: rawSubtotal, fee: 0, final: rawSubtotal };
            let fee = (type === 'buy') ? Math.max(20, Math.floor(rawSubtotal * 0.001425)) : Math.max(20, Math.floor(rawSubtotal * 0.003));
            return { raw: rawSubtotal, fee: fee, final: type === 'buy' ? rawSubtotal + fee : rawSubtotal - fee };
        }

        // 核心計算引擎：處理已實現損益、庫存、與價格極值
        function processData() {
            let totalRealizedProfit = 0;
            let stockState = {}; // { shares, totalBuyCost, realized, minPrice, maxPrice }
            let dailyProfits = {};

            const sortedTrans = [...transactions].sort((a, b) => a.date.localeCompare(b.date) || (a.ts || 0) - (b.ts || 0));

            sortedTrans.forEach(t => {
                const name = (t.name || "未命名").trim();
                const res = calculateTotalWithFees(t.price, t.amount, t.type);
                dailyProfits[t.date] = dailyProfits[t.date] || 0;

                if (!stockState[name]) {
                    stockState[name] = { shares: 0, totalBuyCost: 0, realized: 0, minPrice: Infinity, maxPrice: -Infinity };
                }

                // 紀錄價格極值 (排除股息，通常只紀錄買賣價格)
                if (t.type !== 'dividend') {
                    if (t.price < stockState[name].minPrice) stockState[name].minPrice = t.price;
                    if (t.price > stockState[name].maxPrice) stockState[name].maxPrice = t.price;
                }

                if (t.type === 'dividend') {
                    totalRealizedProfit += res.final;
                    stockState[name].realized += res.final;
                    dailyProfits[t.date] += res.final;
                } 
                else if (t.type === 'buy') {
                    stockState[name].shares += t.amount;
                    stockState[name].totalBuyCost += res.final;
                } 
                else if (t.type === 'sell') {
                    if (stockState[name].shares > 0) {
                        const avgPrice = stockState[name].totalBuyCost / stockState[name].shares;
                        const soldCost = avgPrice * t.amount;
                        const profit = res.final - soldCost;
                        
                        totalRealizedProfit += profit;
                        stockState[name].realized += profit;
                        dailyProfits[t.date] += profit;

                        stockState[name].shares -= t.amount;
                        stockState[name].totalBuyCost -= soldCost;
                        if (stockState[name].shares <= 0) { stockState[name].shares = 0; stockState[name].totalBuyCost = 0; }
                    } else {
                        totalRealizedProfit += res.final;
                        stockState[name].realized += res.final;
                        dailyProfits[t.date] += res.final;
                    }
                }
            });

            return { 
                totalRealizedProfit, 
                currentTotalCost: Object.values(stockState).reduce((acc, s) => acc + s.totalBuyCost, 0),
                dailyProfits,
                stockState
            };
        }

        function updateUI() {
            const data = processData();
            renderCalendar(data.dailyProfits);
            
            // 更新看板數據
            document.getElementById('total-profit').innerText = `$${Math.round(data.totalRealizedProfit).toLocaleString()}`;
            document.getElementById('total-cost').innerText = `$${Math.round(data.currentTotalCost).toLocaleString()}`;
            
            // 頂部持股清單 (股名+股數)
            const holdingsList = document.getElementById('current-holdings-list');
            const currentStocks = Object.entries(data.stockState).filter(([_, s]) => s.shares > 0);
            holdingsList.innerHTML = currentStocks.length 
                ? currentStocks.map(([name, s]) => `<span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-bold">${name} (${s.shares})</span>`).join('') 
                : '<span class="text-gray-400 text-sm italic">尚無持股</span>';

            renderList(data.stockState);
            renderQuickTags();
        }

        function renderCalendar(dailyProfits) {
            const body = document.getElementById('calendar-body');
            const display = document.getElementById('current-month-display');
            const summaryDisplay = document.getElementById('month-summary');
            body.innerHTML = '';
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            display.innerText = `${y}年 ${m + 1}月`;
            const first = new Date(y, m, 1).getDay(), days = new Date(y, m + 1, 0).getDate();
            let monthProfit = 0;

            for (let i = 0; i < first; i++) body.appendChild(Object.assign(document.createElement('div'), { className: 'calendar-day bg-gray-50/50' }));
            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = 'calendar-day p-2 flex flex-col items-start hover:bg-blue-50 cursor-pointer overflow-hidden';
                div.onclick = () => openModal(dateStr);
                div.innerHTML = `<span class="text-xs font-bold text-gray-400 mb-1">${d}</span>`;
                const profit = dailyProfits[dateStr] || 0;
                if (profit !== 0 || transactions.some(t => t.date === dateStr)) {
                    if (profit !== 0) div.innerHTML += `<div class="text-[10px] font-bold px-1 py-0.5 rounded w-full truncate ${profit >= 0 ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-700'}">${profit >= 0 ? '+' : ''}${Math.round(profit).toLocaleString()}</div>`;
                    else div.innerHTML += `<div class="text-[10px] text-gray-400 italic">有交易</div>`;
                    if (new Date(dateStr).getMonth() === m) monthProfit += profit;
                }
                body.appendChild(div);
            }
            summaryDisplay.innerText = `本月結算淨利: ${monthProfit >= 0 ? '+' : ''}${Math.round(monthProfit).toLocaleString()}`;
        }

        function renderList(stockState) {
            const container = document.getElementById('stock-list-container');
            if (!transactions.length) { container.innerHTML = '<p class="text-gray-400 text-center py-4">目前尚無紀錄</p>'; return; }
            
            const grouped = [...transactions].reverse().reduce((acc, t) => {
                const n = (t.name || "未命名").trim(); acc[n] = acc[n] || []; acc[n].push(t); return acc;
            }, {});

            container.innerHTML = Object.keys(grouped).map(name => {
                const stats = stockState[name];
                const trades = grouped[name];
                return `
                <div class="bg-white border border-gray-100 rounded-xl p-4 shadow-sm">
                    <div class="flex flex-col md:flex-row md:items-end justify-between mb-3 border-b border-gray-50 pb-2 gap-2">
                        <div>
                            <span class="text-lg font-bold text-blue-600">${name}</span>
                            <div class="text-[10px] text-gray-400 flex gap-2 mt-0.5">
                                <span>最高價: <b class="text-gray-600">${stats.maxPrice === -Infinity ? '-' : stats.maxPrice}</b></span>
                                <span>最低價: <b class="text-gray-600">${stats.minPrice === Infinity ? '-' : stats.minPrice}</b></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-xs font-bold ${stats.realized >= 0 ? 'text-red-500' : 'text-green-600'}">
                                總已實現損益: ${stats.realized >= 0 ? '+' : ''}${Math.round(stats.realized).toLocaleString()}
                            </span>
                        </div>
                    </div>
                    <div class="text-xs space-y-1">
                        ${trades.map(t => {
                            let typeText = t.type === 'buy' ? '買入' : (t.type === 'sell' ? '賣出' : '股息');
                            let typeClass = t.type === 'buy' ? 'text-red-500' : (t.type === 'sell' ? 'text-green-600' : 'text-blue-500');
                            return `<div class="flex justify-between items-center py-1 cursor-pointer hover:bg-gray-50" onclick="openModal('${t.date}', '${t.id}')">
                                <span class="text-gray-500">${t.date} <b class="${typeClass}">${typeText}</b></span>
                                <span class="font-mono font-bold">$${t.price} &times; ${t.amount}</span>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }).join('');
        }

        // --- UI & 事件處理 (保持不變) ---
        window.openModal = (dateStr, transId = null) => {
            const form = document.getElementById('trade-form'); form.reset();
            document.getElementById('edit-transaction-id').value = transId || "";
            document.getElementById('selected-date').value = dateStr;
            const delBtn = document.getElementById('delete-btn');
            if (transId) {
                const t = transactions.find(x => x.id === transId);
                if (t) {
                    document.getElementById('modal-title').innerText = `編輯項目 (${t.date})`;
                    document.getElementById('stock-name').value = t.name;
                    document.getElementById('trade-type').value = t.type;
                    document.getElementById('trade-price').value = t.price;
                    document.getElementById('trade-amount').value = t.amount;
                    delBtn.classList.remove('hidden');
                }
            } else {
                document.getElementById('modal-title').innerText = `${dateStr} 新增項目`;
                document.getElementById('trade-amount').value = 1000;
                delBtn.classList.add('hidden');
            }
            calculateSubtotal(); document.getElementById('modal').classList.remove('hidden');
        };

        window.calculateSubtotal = () => {
            const price = parseFloat(document.getElementById('trade-price').value) || 0;
            const amount = parseInt(document.getElementById('trade-amount').value) || 0;
            const type = document.getElementById('trade-type').value;
            const res = calculateTotalWithFees(price, amount, type);
            document.getElementById('raw-subtotal').innerText = `$${Math.round(res.raw).toLocaleString()}`;
            document.getElementById('fee-display').innerText = `$${res.fee}`;
            const display = document.getElementById('subtotal-display');
            display.innerText = `$${Math.round(res.final).toLocaleString()}`;
            display.className = (type === 'buy') ? 'text-xl font-bold text-red-500' : (type === 'sell' ? 'text-xl font-bold text-green-600' : 'text-xl font-bold text-blue-500');
        };

        window.renderQuickTags = () => {
            const tagContainer = document.getElementById('quick-stock-tags');
            const existingNames = [...new Set(transactions.map(t => (t.name || "").trim()))].filter(n => n !== "");
            tagContainer.innerHTML = existingNames.map(name => `<span onclick="selectStock('${name}')" class="stock-tag bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] border border-gray-200 font-medium">${name}</span>`).join('') || '<span class="text-[10px] text-gray-400 italic">尚無常用項目</span>';
        };

        window.selectStock = (name) => { document.getElementById('stock-name').value = name; };
        window.changeMonth = (d) => { currentMonth.setMonth(currentMonth.getMonth() + d); updateUI(); };
        window.closeModal = () => document.getElementById('modal').classList.add('hidden');
        window.openSyncModal = () => { document.getElementById('sync-input').value = currentSyncId; document.getElementById('sync-modal').classList.remove('hidden'); };
        window.closeSyncModal = () => document.getElementById('sync-modal').classList.add('hidden');
        window.saveSyncCode = () => { const val = document.getElementById('sync-input').value.trim(); if (val) { currentSyncId = val; localStorage.setItem('user_sync_code', val); startSync(); closeSyncModal(); showToast("同步帳號已切換"); } };
        window.deleteTransaction = async () => { if (!confirm("確定刪除？")) return; await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', `sync_${currentSyncId}`, document.getElementById('edit-transaction-id').value)); showToast("已刪除"); closeModal(); };

        document.getElementById('trade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const transId = document.getElementById('edit-transaction-id').value;
            const data = {
                date: document.getElementById('selected-date').value,
                name: document.getElementById('stock-name').value.trim(),
                type: document.getElementById('trade-type').value,
                price: parseFloat(document.getElementById('trade-price').value) || 0,
                amount: parseInt(document.getElementById('trade-amount').value) || 0,
                ts: transId ? transactions.find(t=>t.id===transId).ts : Date.now()
            };
            if (transId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', `sync_${currentSyncId}`, transId), data);
            else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', `sync_${currentSyncId}`), data);
            showToast("已儲存"); closeModal();
        });

        init();
    </script>
</body>
</html>
