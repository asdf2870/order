<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股市交易紀錄與損益看板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 110px; transition: all 0.2s; border-right: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7; }
        .calendar-day:hover { background-color: #f9fafb; cursor: pointer; }
        .custom-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
    </style>
</head>
<body class="p-4 md:p-8 pb-20">
    <!-- 載入層 -->
    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <p class="mt-4 text-gray-600 font-medium italic">正在初始化雲端連線...</p>
        <p id="error-msg" class="mt-2 text-xs text-red-400 hidden text-center px-4">偵測到連線異常，已切換至本地存取模式</p>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- 損益、持股區 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-blue-500 flex flex-col justify-center">
                <p class="text-sm text-gray-500 font-medium">累積總損益 (已扣手續費/稅)</p>
                <h2 id="total-profit" class="text-4xl font-bold mt-1 text-gray-800">$0</h2>
            </div>
            <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-purple-500 relative">
                <p class="text-sm text-gray-500 font-medium mb-2">目前持有股票</p>
                <div id="current-holdings-list" class="flex flex-wrap gap-2">
                    <span class="text-gray-400 text-sm italic">尚無持股</span>
                </div>
                <button onclick="openSyncModal()" class="absolute top-4 right-4 text-blue-500 hover:text-blue-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.803a4 4 0 015.656 0l4 4a4 4 0 01-5.656 5.656l-1.1-1.1" /></svg>
                </button>
            </div>
        </div>

        <!-- 月份切換 -->
        <div class="bg-white rounded-t-2xl p-4 flex justify-between items-center border-b">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <h3 id="current-month-display" class="text-xl font-bold text-gray-700">正在載入...</h3>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <!-- 日曆 -->
        <div class="bg-white rounded-b-2xl custom-shadow overflow-hidden mb-8">
            <div class="calendar-grid bg-gray-50 border-b">
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">日</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">一</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">二</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">三</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">四</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">五</div>
                <div class="py-3 text-center text-xs font-bold text-gray-400 uppercase tracking-wider">六</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const defaultFirebaseConfig = {
            apiKey: "AIzaSyBzWK76cZTIKEoJGoc9bqi0M4sGLIMsUaE",
            authDomain: "good-e9e4e.firebaseapp.com",
            projectId: "good-e9e4e",
            storageBucket: "good-e9e4e.firebasestorage.app",
            messagingSenderId: "878748843198",
            appId: "1:878748843198:web:6183a33453463ef8e2b2ef"
        };

        let db, auth, user = null, unsubscribe = null;
        let transactions = [];
        let currentMonth = new Date();
        let currentSyncId = localStorage.getItem('user_sync_code') || null;
        const appId = 'stock-tracker-v3';

        const showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        };

        const proceedInit = () => {
            if (!currentSyncId) {
                currentSyncId = user ? user.uid.substring(0, 8) : "guest_" + Math.random().toString(36).substr(2,5);
                localStorage.setItem('user_sync_code', currentSyncId);
            }
            document.getElementById('sync-code-display').innerText = currentSyncId;
            updateUI();
        };

        const updateUI = () => {
            renderCalendar();
        };

        const renderCalendar = () => {
            const body = document.getElementById('calendar-body');
            const display = document.getElementById('current-month-display');
            if (!body) return;

            body.innerHTML = '';
            const y = currentMonth.getFullYear();
            const m = currentMonth.getMonth();
            display.innerText = `${y}年 ${m + 1}月`;

            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < first; i++) {
                const e = document.createElement('div');
                e.className = 'calendar-day bg-gray-50/50';
                body.appendChild(e);
            }

            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const div = document.createElement('div');
                div.className = 'calendar-day p-2 flex flex-col items-start hover:bg-blue-50 cursor-pointer overflow-hidden';
                div.innerHTML = `<span class="text-xs font-bold text-gray-400 mb-1">${d}</span>`;
                body.appendChild(div);
            }
        };

        window.changeMonth = (d) => { currentMonth.setMonth(currentMonth.getMonth() + d); updateUI(); };

        // --- 立即渲染日曆 ---
        document.getElementById('loader').classList.add('hidden'); // 隱藏 loader
        proceedInit();

        // --- Firebase 初始化同步 (非阻塞) ---
        try {
            const app = initializeApp(defaultFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            signInAnonymously(auth).then(() => {
                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        console.log("Firebase 登入完成，UID:", user.uid);
                        // TODO: 這裡可加 startSync() 同步交易
                    }
                });
            });
        } catch(e) {
            console.warn("Firebase 初始化失敗，本地模式使用", e);
            document.getElementById('error-msg').classList.remove('hidden');
        }
    </script>
</body>
</html>
