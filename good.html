<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>股市交易紀錄與損益看板 (Fallback版)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
.calendar-day { min-height: 110px; transition: all 0.2s; border-right: 1px solid #edf2f7; border-bottom: 1px solid #edf2f7; }
.calendar-day:hover { background-color: #f9fafb; cursor: pointer; }
.custom-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
.loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; align-items: center; justify-content: center; z-index: 100; flex-direction: column; }
</style>
</head>
<body class="p-4 md:p-8 pb-20">

<div id="loader" class="loading-overlay">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    <p class="mt-4 text-gray-600 font-medium italic">正在初始化雲端連線...</p>
    <p id="error-msg" class="mt-2 text-xs text-red-400 hidden text-center px-4">偵測到連線異常，已切換至本地存取模式</p>
</div>

<div class="max-w-6xl mx-auto">
    <!-- UI: 總損益 / 持股 / 日曆 / 交易表等... -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-blue-500 flex flex-col justify-center">
            <p class="text-sm text-gray-500 font-medium">累積總損益 (已扣手續費/稅)</p>
            <h2 id="total-profit" class="text-4xl font-bold mt-1 text-gray-800">$0</h2>
        </div>
        <div class="bg-white p-6 rounded-2xl custom-shadow border-l-4 border-purple-500 relative">
            <p class="text-sm text-gray-500 font-medium mb-2">目前持有股票</p>
            <div id="current-holdings-list" class="flex flex-wrap gap-2">
                <span class="text-gray-400 text-sm italic">尚無持股</span>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-t-2xl p-4 flex justify-between items-center border-b">
        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition">&lt;</button>
        <h3 id="current-month-display" class="text-xl font-bold text-gray-700">正在載入...</h3>
        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition">&gt;</button>
    </div>

    <div class="bg-white rounded-b-2xl custom-shadow overflow-hidden mb-8">
        <div class="calendar-grid bg-gray-50 border-b">
            <div class="py-3 text-center text-xs font-bold text-gray-400">日</div>
            <div class="py-3 text-center text-xs font-bold text-gray-400">一</div>
            <div class="py-3 text-center text-xs font-bold text-gray-400">二</div>
            <div class="py-3 text-center text-xs font-bold text-gray-400">三</div>
            <div class="py-3 text-center text-xs font-bold text-gray-400">四</div>
            <div class="py-3 text-center text-xs font-bold text-gray-400">五</div>
            <div class="py-3 text-center text-xs font-bold text-gray-400">六</div>
        </div>
        <div id="calendar-body" class="calendar-grid"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

let db = null, auth = null;
let transactions = [];
let currentMonth = new Date();
let user = null;
let unsubscribe = null;

const defaultFirebaseConfig = {
    apiKey: "AIzaSyBzWK76cZTIKEoJGoc9bqi0M4sGLIMsUaE",
    authDomain: "good-e9e4e.firebaseapp.com",
    projectId: "good-e9e4e",
    storageBucket: "good-e9e4e.appspot.com",
    messagingSenderId: "878748843198",
    appId: "1:878748843198:web:6183a33453463ef8e2b2ef"
};

function showToast(msg) {
    alert(msg);
}

async function init() {
    try {
        const app = initializeApp(defaultFirebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        await signInAnonymously(auth);
        user = auth.currentUser;
        console.log("Firebase 初始化成功", user.uid);
    } catch(e) {
        console.warn("Firebase 初始化失敗，使用本地模式", e);
        document.getElementById('error-msg').classList.remove('hidden');
        user = { uid: "guest_" + Math.random().toString(36).substr(2,5) };
        db = null; // 本地模式不使用 Firestore
    }
    document.getElementById('loader').classList.add('hidden');
    proceedInit();
}

function proceedInit() {
    // 如果有 Firebase db，就啟動同步
    if (db && user) startSync();
    renderCalendar();
}

function startSync() {
    if (!db) return;
    const colRef = collection(db, 'artifacts', 'stock-tracker-v3', 'public', 'data', `sync_${user.uid}`);
    unsubscribe = onSnapshot(colRef, snap => {
        transactions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.ts||0)-(a.ts||0));
        renderCalendar();
    });
}

function renderCalendar() {
    const body = document.getElementById('calendar-body');
    const display = document.getElementById('current-month-display');
    if (!body) return;
    body.innerHTML = '';
    const y = currentMonth.getFullYear();
    const m = currentMonth.getMonth();
    display.innerText = `${y}年 ${m+1}月`;
    const first = new Date(y,m,1).getDay();
    const days = new Date(y,m+1,0).getDate();
    for (let i=0;i<first;i++){
        const e = document.createElement('div'); e.className='calendar-day bg-gray-50/50'; body.appendChild(e);
    }
    for (let d=1;d<=days;d++){
        const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const div = document.createElement('div');
        div.className='calendar-day p-2 flex flex-col items-start hover:bg-blue-50 cursor-pointer overflow-hidden';
        div.onclick = ()=>alert("點選日期: "+dateStr);
        div.innerHTML = `<span class="text-xs font-bold text-gray-400 mb-1">${d}</span>`;
        body.appendChild(div);
    }
}

window.changeMonth = (d)=>{ currentMonth.setMonth(currentMonth.getMonth()+d); renderCalendar(); };

init();
</script>

</body>
</html>
