<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>餐廳叫貨管理系統 - 雲端同步版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .selectable-text { user-select: text !important; -webkit-user-select: text !important; }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebase 設定區 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDS7PQrDh05bIGu9WYCcFM0s1GvhzDwz4M",
            authDomain: "order-718b1.firebaseapp.com",
            projectId: "order-718b1",
            storageBucket: "order-718b1.firebasestorage.app",
            messagingSenderId: "454465000018",
            appId: "1:454465000018:web:ac7c787ba3e423a2a1458b",
            databaseURL: "https://order-718b1-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // 初始化 Firebase
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { useState, useEffect, useMemo } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons({
                        attrs: { class: className, 'stroke-width': 2, width: size, height: size },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, size, className]);
            return <i data-lucide={name} className={className}></i>;
        };

        const App = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [vendors, setVendors] = useState([]);
            const [exclusions, setExclusions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingVendor, setEditingVendor] = useState(null);
            const [showVendorModal, setShowVendorModal] = useState(false);
            const [copiedId, setCopiedId] = useState(null);

            // 1. 監聽 Firebase 雲端資料 (取代 localStorage)
            useEffect(() => {
                const dataRef = db.ref('order_system');
                dataRef.on('value', (snapshot) => {
                    const val = snapshot.val();
                    if (val) {
                        setVendors(val.vendors || []);
                        setExclusions(val.exclusions || []);
                    } else {
                        // 如果雲端沒資料，初始化一筆
                        const initialData = [
                            { id: 1, name: '大漢生鮮蔬果', color: 'bg-green-500', items: '青江菜 10斤\n番茄 5盒\n洋蔥 1袋', orderDays: [1, 3, 5] }
                        ];
                        db.ref('order_system').set({ vendors: initialData, exclusions: [] });
                    }
                    setLoading(false);
                });
                return () => dataRef.off();
            }, []);

            // 2. 統一寫入雲端的方法
            const syncToCloud = (newVendors, newExclusions) => {
                db.ref('order_system').update({
                    vendors: newVendors,
                    exclusions: newExclusions
                });
            };

            const copyToClipboard = (text, id) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopiedId(id);
                    setTimeout(() => setCopiedId(null), 2000);
                } catch (err) { console.error('無法複製', err); }
                document.body.removeChild(textArea);
            };

            const weekDays = useMemo(() => {
                const startOfWeek = new Date(currentDate);
                startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    const dateStr = d.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                    const dayEvents = vendors.flatMap(v => {
                        const key = `${dateStr}-${v.id}`;
                        return (v.orderDays && v.orderDays.includes(d.getDay()) && !exclusions.includes(key)) 
                            ? [{ color: v.color, vendor: v.name, dateKey: key }] : [];
                    });
                    days.push({ day: d.getDate(), month: d.getMonth() + 1, dateStr, events: dayEvents });
                }
                return days;
            }, [currentDate, vendors, exclusions]);

            const colorOptions = [
                { label: '藍色', value: 'bg-blue-500' }, { label: '紅色', value: 'bg-red-500' },
                { label: '綠色', value: 'bg-green-500' }, { label: '橘色', value: 'bg-amber-500' },
                { label: '紫色', value: 'bg-purple-500' }, { label: '青色', value: 'bg-cyan-500' },
                { label: '粉色', value: 'bg-pink-500' }, { label: '灰色', value: 'bg-slate-500' }
            ];

            if (loading) return <div className="flex h-screen items-center justify-center text-slate-400 font-bold animate-pulse">同步雲端資料中...</div>;

            return (
                <div className="min-h-screen pb-10">
                    <header className="bg-white border-b sticky top-0 z-30 p-4 shadow-sm flex justify-between items-center">
                        <h1 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                            <Icon name="clipboard-list" className="text-blue-600" size={24} /> 叫貨系統
                        </h1>
                        <button onClick={() => { setEditingVendor(null); setShowVendorModal(true); }} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold shadow-md active:scale-95">
                            新增廠商
                        </button>
                    </header>

                    <main className="max-w-2xl mx-auto p-4 space-y-6">
                        {/* 日曆卡片 */}
                        <section className="bg-white rounded-2xl shadow-sm border overflow-hidden">
                            <div className="p-4 border-b flex justify-between items-center bg-slate-50/50">
                                <h2 className="font-bold flex items-center gap-2 text-slate-700"><Icon name="calendar" size={18} className="text-slate-400" /> 本週排程</h2>
                                <div className="flex border rounded-lg bg-white overflow-hidden shadow-sm">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate() - 7)))} className="p-2 border-r active:bg-slate-100"><Icon name="chevron-left" size={16}/></button>
                                    <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1 text-xs font-bold text-blue-600 active:bg-slate-100">今天</button>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.setDate(currentDate.getDate() + 7)))} className="p-2 border-l active:bg-slate-100"><Icon name="chevron-right" size={16}/></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-7 text-center text-[10px] font-bold text-slate-400 py-2 border-b bg-slate-50/20">
                                {['日','一','二','三','四','五','六'].map(d => <div key={d}>{d}</div>)}
                            </div>
                            <div className="grid grid-cols-7 min-h-[120px]">
                                {weekDays.map((d, i) => (
                                    <div key={i} className={`border-r last:border-r-0 p-1 min-h-[120px] ${d.dateStr === new Date().toISOString().split('T')[0] ? 'bg-blue-50/20' : ''}`}>
                                        <div className={`text-[10px] text-center mb-1 font-bold ${[0,6].includes(i) ? 'text-red-400' : 'text-slate-400'}`}>{d.day}</div>
                                        <div className="space-y-1">
                                            {d.events.map((ev, idx) => (
                                                <button 
                                                    key={idx} 
                                                    onClick={() => confirm(`確定取消 ${ev.vendor} 在此日的叫貨？`) && syncToCloud(vendors, [...exclusions, ev.dateKey])}
                                                    className={`${ev.color} text-white text-[9px] p-1 rounded-md text-center block w-full truncate shadow-sm active:scale-90 transition-transform`}
                                                >
                                                    {ev.vendor}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </section>

                        {/* 明細清單 */}
                        <section className="space-y-4">
                            <h3 className="font-bold text-slate-500 flex items-center gap-2 px-1">
                                <Icon name="package" size={18} /> 商品明細一鍵複製
                            </h3>
                            {vendors.map(v => (
                                <div key={v.id} className="bg-white border rounded-2xl shadow-sm overflow-hidden transition-all hover:shadow-md">
                                    <div className="p-3 bg-slate-50/50 border-b flex justify-between items-center">
                                        <div className="flex items-center gap-2 font-bold text-slate-700">
                                            <div className={`w-3 h-3 rounded-full ${v.color}`}></div>
                                            {v.name}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => { setEditingVendor(v); setShowVendorModal(true); }} className="p-2 text-slate-400 hover:text-blue-600"><Icon name="edit-2" size={16}/></button>
                                            <button onClick={() => copyToClipboard(v.items, v.id)}
                                                className={`flex items-center gap-1 px-4 py-1.5 rounded-xl font-bold text-sm transition-all active:scale-95 ${copiedId === v.id ? 'bg-green-500 text-white' : 'bg-blue-600 text-white shadow-sm'}`}>
                                                <Icon name={copiedId === v.id ? "check" : "copy"} size={14} />
                                                {copiedId === v.id ? "已複製" : "整份複製"}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="p-4 bg-white">
                                        <pre className="whitespace-pre-wrap text-sm text-slate-600 font-sans leading-relaxed selectable-text">{v.items || "尚未輸入品項"}</pre>
                                    </div>
                                </div>
                            ))}
                        </section>
                    </main>

                    {/* 編輯廠商視窗 */}
                    {showVendorModal && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center backdrop-blur-sm">
                            <div className="bg-white w-full max-w-md rounded-t-3xl sm:rounded-2xl p-6 max-h-[90vh] overflow-y-auto shadow-2xl animate-in slide-in-from-bottom duration-300">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-800">{editingVendor ? '編輯廠商' : '新增廠商'}</h3>
                                    <button onClick={() => { setShowVendorModal(false); setEditingVendor(null); }} className="p-2 bg-slate-100 rounded-full active:scale-90"><Icon name="x" /></button>
                                </div>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const fd = new FormData(e.target);
                                    const data = {
                                        id: editingVendor?.id || Date.now(),
                                        name: fd.get('name'),
                                        color: fd.get('color'),
                                        items: fd.get('items'),
                                        orderDays: fd.getAll('orderDays').map(Number)
                                    };
                                    const newVendors = editingVendor ? vendors.map(v => v.id === editingVendor.id ? data : v) : [...vendors, data];
                                    syncToCloud(newVendors, exclusions);
                                    setShowVendorModal(false);
                                    setEditingVendor(null);
                                }} className="space-y-5">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">廠商名稱</label>
                                        <input name="name" defaultValue={editingVendor?.name} placeholder="例如：大漢生鮮" required className="w-full border-2 p-3 rounded-xl outline-none focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">標籤顏色</label>
                                        <div className="grid grid-cols-4 gap-3">
                                            {colorOptions.map(c => (
                                                <label key={c.value} className="cursor-pointer group">
                                                    <input type="radio" name="color" value={c.value} defaultChecked={editingVendor?.color === c.value || (!editingVendor && c.value === 'bg-blue-500')} className="hidden peer" />
                                                    <div className={`aspect-square rounded-xl ${c.value} border-4 border-transparent peer-checked:border-white peer-checked:ring-2 peer-checked:ring-blue-500 transition-all flex items-center justify-center`}>
                                                        <Icon name="check" size={16} className="text-white opacity-0 peer-checked:opacity-100" />
                                                    </div>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider">叫貨週期</label>
                                        <div className="flex justify-between gap-1">
                                            {[0,1,2,3,4,5,6].map(d => (
                                                <label key={d} className="flex-1 cursor-pointer">
                                                    <input type="checkbox" name="orderDays" value={d} defaultChecked={editingVendor?.orderDays?.includes(d)} className="hidden peer" />
                                                    <div className="h-10 flex items-center justify-center rounded-xl border-2 border-slate-100 text-slate-400 font-bold peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 text-xs">
                                                        {['日','一','二','三','四','五','六'][d]}
                                                    </div>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-400 mb-1 uppercase tracking-wider">叫貨品項內容</label>
                                        <textarea name="items" defaultValue={editingVendor?.items} placeholder="請輸入品項明細..." className="w-full border-2 p-3 rounded-xl h-32 outline-none focus:border-blue-500" spellCheck="false"></textarea>
                                    </div>
                                    <div className="flex gap-3 pt-2">
                                        {editingVendor && (
                                            <button type="button" 
                                                onClick={() => confirm('確定刪除此廠商？') && syncToCloud(vendors.filter(v => v.id !== editingVendor.id), exclusions) && setShowVendorModal(false)}
                                                className="px-4 bg-red-50 text-red-600 rounded-2xl font-bold active:scale-95"
                                            >刪除</button>
                                        )}
                                        <button type="submit" className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-100 active:scale-95">
                                            儲存並同步到雲端
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
